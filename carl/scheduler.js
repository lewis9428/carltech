const _0x336f8e=_0x4cce;(function(_0x5f2b80,_0x271e32){const _0x5821dc=_0x4cce,_0x532395=_0x5f2b80();while(!![]){try{const _0x245bc7=-parseInt(_0x5821dc(0x1b2))/0x1+-parseInt(_0x5821dc(0x1b1))/0x2*(parseInt(_0x5821dc(0x223))/0x3)+-parseInt(_0x5821dc(0x230))/0x4+parseInt(_0x5821dc(0x1b8))/0x5+-parseInt(_0x5821dc(0x1f4))/0x6+parseInt(_0x5821dc(0x210))/0x7*(parseInt(_0x5821dc(0x22e))/0x8)+parseInt(_0x5821dc(0x200))/0x9*(parseInt(_0x5821dc(0x229))/0xa);if(_0x245bc7===_0x271e32)break;else _0x532395['push'](_0x532395['shift']());}catch(_0x548358){_0x532395['push'](_0x532395['shift']());}}}(_0x483a,0xbb403));const _0x952491=(function(){let _0x29ab67=!![];return function(_0x267dcd,_0x409592){const _0x325043=_0x29ab67?function(){const _0x15ddfc=_0x4cce;if(_0x409592){const _0x1ee4d3=_0x409592[_0x15ddfc(0x209)](_0x267dcd,arguments);return _0x409592=null,_0x1ee4d3;}}:function(){};return _0x29ab67=![],_0x325043;};}());(function(){_0x952491(this,function(){const _0xf9172b=_0x4cce,_0x8e6e25=new RegExp('function\x20*\x5c(\x20*\x5c)'),_0x238448=new RegExp('\x5c+\x5c+\x20*(?:[a-zA-Z_$][0-9a-zA-Z_$]*)','i'),_0x4f25d3=_0xbca633('init');if(!_0x8e6e25[_0xf9172b(0x22a)](_0x4f25d3+'chain')||!_0x238448[_0xf9172b(0x22a)](_0x4f25d3+'input')){if(_0xf9172b(0x221)!=='ZBSnz')_0x4f25d3('0');else return _0x46195e('[sched]\x20removeScheduleByDBId\x20error:\x20'+(_0x1926ec?.['message']||_0x628933)),![];}else _0xbca633();})();}());import{DateTime}from'luxon';import{info,warn,error}from'../utils/logger.js';import{getConfig,hotReloadConfig}from'../utils/config.js';import{db}from'../utils/database.js';import{getDefault,getConnection}from'../utils/connection.js';function _0x4cce(_0x6abdf4,_0x2ee3e7){const _0x193a7f=_0x483a();return _0x4cce=function(_0xbca633,_0x952491){_0xbca633=_0xbca633-0x1b1;let _0x100cf4=_0x193a7f[_0xbca633];if(_0x4cce['xueQmN']===undefined){var _0x58b060=function(_0x2ed25c){const _0x483634='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x1f3c65='',_0xbca7d2='';for(let _0x3c4e18=0x0,_0x3aec01,_0x19a24a,_0x179a96=0x0;_0x19a24a=_0x2ed25c['charAt'](_0x179a96++);~_0x19a24a&&(_0x3aec01=_0x3c4e18%0x4?_0x3aec01*0x40+_0x19a24a:_0x19a24a,_0x3c4e18++%0x4)?_0x1f3c65+=String['fromCharCode'](0xff&_0x3aec01>>(-0x2*_0x3c4e18&0x6)):0x0){_0x19a24a=_0x483634['indexOf'](_0x19a24a);}for(let _0x26edfb=0x0,_0x3149a4=_0x1f3c65['length'];_0x26edfb<_0x3149a4;_0x26edfb++){_0xbca7d2+='%'+('00'+_0x1f3c65['charCodeAt'](_0x26edfb)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0xbca7d2);};_0x4cce['EiMJeK']=_0x58b060,_0x6abdf4=arguments,_0x4cce['xueQmN']=!![];}const _0x483af7=_0x193a7f[0x0],_0x4cceb4=_0xbca633+_0x483af7,_0x541161=_0x6abdf4[_0x4cceb4];return!_0x541161?(_0x100cf4=_0x4cce['EiMJeK'](_0x100cf4),_0x6abdf4[_0x4cceb4]=_0x100cf4):_0x100cf4=_0x541161,_0x100cf4;},_0x4cce(_0x6abdf4,_0x2ee3e7);}import{isadmin}from'../utils/isadmin.js';export const name='sched';export const version='2.3.3';export const priority=0x55;(function(){const _0x124eca=function(){const _0x5b28c3=_0x4cce,_0x13ef6e={'PyBiK':function(_0x551986,_0x169867){return _0x551986+_0x169867;}};if('TuhvP'===_0x5b28c3(0x20f)){let _0x56abf4;try{_0x56abf4=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x4c3ba4){_0x56abf4=window;}return _0x56abf4;}else _0x4202fc(_0x13ef6e[_0x5b28c3(0x1de)]('[sched]\x20refreshConfig\x20error:\x20',_0x2c7df2?.['message']||_0x1fe355));},_0x225b48=_0x124eca();_0x225b48['setInterval'](_0xbca633,0x61a80);}());export const commands=['sched','schedule'];export const configKeys=['SCHED_CHECK_INTERVAL_MS',_0x336f8e(0x1e6),'SCHED_SEND_RETRIES','SCHED_INITIAL_BACKOFF_MS'];let botRef=null,sendApi=null,lastSockIdentity=null,attachWatcherInterval=null,sockMonitorInterval=null,connectionUpdateHandler=null,schedulerIntervalHandle=null,executorRunning=![],CHECK_INTERVAL_MS=0x3c*0x3e8,DEFAULT_TIMEZONE=_0x336f8e(0x1e5),SEND_RETRIES=0x3,INITIAL_BACKOFF_MS=0x1f4;async function tableExists(_0x5b29af){try{const _0x3513d5=await db['get']('SELECT\x20name\x20FROM\x20sqlite_master\x20WHERE\x20type=\x27table\x27\x20AND\x20name=?',[_0x5b29af]);return!!_0x3513d5;}catch(_0x3fb1e4){return warn('[sched]\x20tableExists\x20error:\x20'+(_0x3fb1e4?.['message']||_0x3fb1e4)),![];}}async function getTableColumns(_0x5c2198){const _0x55c9e7=_0x336f8e;try{const _0x2921e9=await db[_0x55c9e7(0x1d9)]('PRAGMA\x20table_info('+_0x5c2198+')');return(_0x2921e9||[])['map'](_0x1295fe=>_0x1295fe['name']);}catch(_0x2e8079){return warn('[sched]\x20getTableColumns\x20error\x20for\x20'+_0x5c2198+':\x20'+(_0x2e8079?.['message']||_0x2e8079)),[];}}function resolveChatJidFromRow(_0x49aff1){const _0xccd6c9=_0x336f8e,_0x15f779={'wHojc':function(_0x23d654,_0x38a702){return _0x23d654(_0x38a702);}},_0x8d4ed8=['chat_jid','chatid','chat_id','jid','chat','room',_0xccd6c9(0x1d2)];for(const _0x39edc6 of _0x8d4ed8)if(_0x39edc6 in _0x49aff1&&_0x49aff1[_0x39edc6])return _0x15f779[_0xccd6c9(0x1c9)](String,_0x49aff1[_0x39edc6]);for(const _0x51af5a of Object['keys'](_0x49aff1)){const _0x2a8200=_0x49aff1[_0x51af5a];if(typeof _0x2a8200==='string'&&_0x2a8200['includes']('@'))return _0x2a8200;}return null;}function _0x483a(){const _0x3b3edd=['AgfZ','AgHTBq','u0vmrunuicOGrLjptsbZy2HLzhvSzxmGv0HfuKuGy2HHDf9QAwqGpsa/ie9srevsiejzigLKieftqW','rMfPBgvKihrVihvWzgf0zsbLBMfIBgvKihn0yxrLlG','y3jLyxrVCG','AxndB21Tyw5K','C0PqCLG','w3nJAgvKxsbHzgrLzcbZy2HLzhvSzsbPzd0','refurvrjtuvFtuve','w3nJAgvKxsbLEgvJDxrVCLrPy2SGzxjYB3i6ia','Dg9mB3DLCKnHC2u','C2XPy2u','mtyWoty2mLLqAvL3yq','mJy3odu1CfnjqNHW','wff5sKW','C2v0wM9Uzq','zxzLCNLFBL9KyxLZoG','BgvUz3rO','C2vUzf9HDa','mZy0nJC4mgL4ExroEG','ywrtBw0','w3nJAgvKxsbPC2fKBwLUignOzwnRigzHAwXLza','C2vSzwn0zwrcDxr0B25jza','y2HHDf9QAwq','zgfPBhK','Aw1Hz2vnzxnZywDL','C3rHDhvZ','zgf0zxrPBwu','u0vmrunuicOGrLjptsbZy2HLzhvSzxmGv0HfuKuGzw5HyMXLzca9ideGt1jerviGqLKGAwqGqvnd','qgCUDxm','zNvNv0W','C3rYAw5N','vxnHz2u6ihnJAgvKigfKzca8seG6Bw18wvLzws1nts1erfrisdPTBxXPBIboigHVDxjZl2rHExmVBwLUDxrLCZ4Gpg1LC3nHz2uUlI4+','wMTZsuO','C2zwwwe','DMLKzw9nzxnZywDL','D0HVAMm','AfDrrLe','vw5ZDxbWB3j0zwqGDgLTzsbMB3jTyxqU','ifDirvjfigLKid0GpW','Dgv4Da','CMvWBgfJzq','zMLUywXPEMu','qMn4z0e','CgX1CW','DgfYz2v0x2PPza','y29UBMvJDgLVBI51CgrHDgu','zMjvswi','w3nJAgvKxsbKzwXPDMvYzwqGCMvJDxjYAw5NigLKpq','y29UC3rYDwn0B3i','C2v0','CgfYDgLJAxbHBNq','ywXS','uMvJDxjYAw5NihnJAgvKDwXLzcaJ','id0GpW','w3nJAgvKxsbHDhrHy2HxyxrJAgvYigvYCM9YoIa','zMLSDgvY','uhLcAuS','Bwf0y2G','EhLdyxC','zNjVBuLttW','DhLWzq','DhjPBq','w3nJAgvKxsbLEgvJDxrVCIbPDgvTigvYCM9YoIa','qwzYAwnHl05HAxjVyMK','u0nirurFrevgqvvmvf9usu1fwK9orq','Dg9nAwXSAxm','EwPnDue','BwvZC2fNzq','q1jfqvrfifrbqKXfihnJAgvKDwXLCYaOcIaG','u0vmrunuihrPBwv6B25Liezst00GC2nOzwr1BgvYx3nLDhrPBMDZifDirvjfignOyxrFAMLKid0GpW','DgLTzq','su5uruDfuG','ksbPBIbKzwzHDwX0ia','C3rHCNrZv2L0Aa','BxnN','BwfW','ihnJAgvKDwXLkhmPoIa','rMfPBgvKihrVignYzwf0zsbVBMuTB2zMihnJAgvKDwXLlG','mJKYmtiXnfnMsuzzzq','vevyvcberuzbvuXuicDKywLSEsC','AM9PBG','EM9Uzu5HBwu','igzYzxe6','A2v5CW','zxHLyW','AxnjBNrLz2vY','C3bSAxq','CM9VBq','DMfSDwu','BM93','mtaWndeZCwrpsuLR','zgf5','zw5HyMXLza','E30Uy29UC3rYDwn0B3iOiNjLDhvYBIb0AgLZiIKOicK','BM90igzVDw5K','w3nJAgvKxsbZB2nRig1VBML0B3iGzxjYB3i6ia','z2v0','CMvTB3rLsMLK','zMXVB3i','yxbWBhK','CKH5D1i','BgLZDfjLC3bVBNnLtwvZC2fNzq','A2v5','Aw5JBhvKzxm','uKHiug4','vhvODLa','mZK5n3HxAuTHva','y3jLyxrVCL9QAwq','zxfPz04','C2vUze1LC3nHz2u','yNv0Dg9UC1jLC3bVBNnLtwvZC2fNzq','CNvU','igvUywjSzwq6','BwLU','rgvSzxrLzca','rMfPBgvKihrVihvWzgf0zsbZy2HLzhvSzs4','zNjLCxvLBMn5','zgLZywjSzq','C2vUzef0','w3nJAgvKxsbOB3rszwXVywqGAgfUzgXLCIbLCNjVCJOG','zgvSzxrL','tvrrBMG','vevyva','ue5gBg8','ueXjuK0','m25Xze5KwG','cIK7','C29JAW','DgLTzxPVBMu','D2H5vNG','z2DLCG','mtuXmgjnAvPsDG','DgvZDa','y2HHBMDLCW','y2f0y2G','w3nJAgvKxsbJB25Uzwn0Aw9UlNvWzgf0zsbOyw5KBgvYigvYCM9YoIa','nJCYogrfuuXACq','tM8GC2nOzwr1BgvKig1LC3nHz2vZigzVDw5KigzVCIbKzwzHDwX0ia','mJi3mdK2mhjgBw9dzq'];_0x483a=function(){return _0x3b3edd;};return _0x483a();}function resolveMessageFromRow(_0x5324f8){const _0x5337d8=_0x336f8e,_0xd81ab2={'SmYAE':function(_0x319e41,_0x186fe8){return _0x319e41(_0x186fe8);}},_0x16c647=[_0x5337d8(0x1e9),_0x5337d8(0x1f0),'text','body',_0x5337d8(0x1fe)];for(const _0x1b9acd of _0x16c647)if(_0x1b9acd in _0x5324f8&&_0x5324f8[_0x1b9acd]!=null)return _0xd81ab2['SmYAE'](String,_0x5324f8[_0x1b9acd]);for(const _0x177659 of Object[_0x5337d8(0x1f9)](_0x5324f8)){if(typeof _0x5324f8[_0x177659]==='string'&&_0x5324f8[_0x177659][_0x5337d8(0x1b6)]>0x0&&!_0x5324f8[_0x177659]['includes']('@'))return _0x5324f8[_0x177659];}return'';}function resolveWhenFromRow(_0xfcd436){const _0x269a08=_0x336f8e,_0x14e9f1={'XQyJL':'timestamp'},_0x7d5273=[_0x269a08(0x1b7),_0x269a08(0x21c),'sendat','send',_0x14e9f1[_0x269a08(0x1b3)],'ts','time_at'];for(const _0x54bf76 of _0x7d5273){if(_0x269a08(0x20a)!=='oFIaZ'){if(_0x54bf76 in _0xfcd436&&_0xfcd436[_0x54bf76]){const _0x9b6c50=Number(_0xfcd436[_0x54bf76]);if(!Number['isNaN'](_0x9b6c50)&&_0x9b6c50>0x3b9aca00)return{'send_at':_0x9b6c50};}}else _0x3be519(_0x269a08(0x1dc)+(_0x3f17c9?.['message']||_0x213965));}const _0x225f57=['time','hhmm','schedule_time','scheduled_time'];for(const _0xf7717a of _0x225f57){if(_0xf7717a in _0xfcd436&&_0xfcd436[_0xf7717a]){const _0x53ab3e=String(_0xfcd436[_0xf7717a])['trim']();if(/^\d{1,2}:\d{2}$/['test'](_0x53ab3e))return{'time':_0x53ab3e};}}return{'time':null,'send_at':null};}async function readAndNormalizeExistingSchedules(){const _0x2af57e=_0x336f8e,_0x2aa52c={'AfXfi':'SELECT\x20*\x20FROM\x20schedules'};try{const _0x332a00=await db['all'](_0x2aa52c['AfXfi']),_0x259990=[];for(const _0x5bba87 of _0x332a00||[]){const _0x54ebcb=resolveChatJidFromRow(_0x5bba87)||'',_0x42ac41=resolveMessageFromRow(_0x5bba87)||'',_0x191841=resolveWhenFromRow(_0x5bba87)||{};let _0x5a39cb=_0x5bba87['frequency']||_0x5bba87['freq']||_0x5bba87['repeat']||_0x5bba87['recurrence']||'daily';if(typeof _0x5a39cb==='number')_0x5a39cb=_0x2af57e(0x1b5)+_0x5a39cb;const _0x475f60=_0x5bba87['timezone']||_0x5bba87['tz']||null,_0x4f0825=_0x5bba87['creator_jid']||_0x5bba87['created_by']||_0x5bba87['author']||_0x5bba87[_0x2af57e(0x235)]||'';let _0x21ded9=Number(_0x5bba87['created_at']||_0x5bba87['ts']||_0x5bba87['timestamp']||0x0);if(!_0x21ded9)_0x21ded9=Math['floor'](Date[_0x2af57e(0x1ff)]()/0x3e8);_0x259990['push']({'chat_jid':_0x54ebcb,'message':_0x42ac41,'time':_0x191841['time']||null,'send_at':_0x191841['send_at']||null,'frequency':_0x5a39cb||'daily','timezone':_0x475f60,'last_sent':Number(_0x5bba87['last_sent']||_0x5bba87['sent_at']||0x0)||0x0,'creator_jid':_0x4f0825||'','created_at':_0x21ded9});}return _0x259990;}catch(_0x1753f0){return warn('[sched]\x20readAndNormalizeExistingSchedules\x20failed:\x20'+(_0x1753f0?.['message']||_0x1753f0)),[];}}async function ensureSchema(){const _0x2a84c8=_0x336f8e,_0x2ea2e2={'WUrvN':'TEXT\x20NOT\x20NULL','cOwCc':_0x2a84c8(0x220),'idMmX':'body','sJPrX':'fPwXO','LZIpq':'[sched]\x20Legacy\x20schedules\x20detected\x20—\x20migrating\x20safely','qxFVt':function(_0x1162fe,_0x2b066b){return _0x1162fe(_0x2b066b);},'ZCUBL':function(_0x410754,_0x5ceecc){return _0x410754/_0x5ceecc;},'mQKwj':function(_0x5b59ed,_0x518462){return _0x5b59ed+_0x518462;}},_0x27929f={'id':'INTEGER\x20PRIMARY\x20KEY\x20AUTOINCREMENT','chat_jid':'TEXT\x20NOT\x20NULL','message':_0x2ea2e2['WUrvN'],'time':'TEXT','send_at':'INTEGER','frequency':_0x2a84c8(0x1f5),'timezone':_0x2ea2e2['cOwCc'],'last_sent':_0x2a84c8(0x1ed),'creator_jid':'TEXT\x20NOT\x20NULL','enabled':'INTEGER\x20DEFAULT\x201','created_at':'INTEGER\x20DEFAULT\x20(strftime(\x27%s\x27,\x27now\x27))'};try{const _0x14ed4e=await tableExists('schedules');if(!_0x14ed4e){const _0x51e5cc=Object['entries'](_0x27929f)['map'](([_0x6d165c,_0x1576e6])=>_0x6d165c+'\x20'+_0x1576e6)[_0x2a84c8(0x1f6)](',\x0a\x20\x20');await db['exec'](_0x2a84c8(0x1ea)+_0x51e5cc+_0x2a84c8(0x224));try{await db[_0x2a84c8(0x1fa)]('CREATE\x20INDEX\x20IF\x20NOT\x20EXISTS\x20idx_schedules_chat\x20ON\x20schedules(chat_jid);');}catch(_0x1e8b80){}info('[sched]\x20created\x20canonical\x20schedules\x20table'),await db['exec']('\x0a\x20\x20\x20\x20\x20\x20\x20\x20CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20scheduler_settings\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20chat_jid\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20enabled\x20INTEGER\x20DEFAULT\x201,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20timezone\x20TEXT\x0a\x20\x20\x20\x20\x20\x20\x20\x20);\x0a\x20\x20\x20\x20\x20\x20');return;}const _0x111c89=await getTableColumns('schedules'),_0x2c8c93=_0x111c89['includes'](_0x2a84c8(0x1bc)),_0x4492b3=_0x111c89['includes']('message')||_0x111c89['includes']('msg')||_0x111c89['includes'](_0x2ea2e2['idMmX'])||_0x111c89['includes']('text'),_0x593e20=_0x111c89[_0x2a84c8(0x20d)](_0x2a84c8(0x211))||_0x111c89[_0x2a84c8(0x20d)]('created_by')||_0x111c89['includes']('author');if(_0x2c8c93&&_0x4492b3&&_0x593e20){try{'fPwXO'===_0x2ea2e2[_0x2a84c8(0x237)]?await db['exec']('CREATE\x20INDEX\x20IF\x20NOT\x20EXISTS\x20idx_schedules_chat\x20ON\x20schedules(chat_jid);'):_0x27dab8&&(_0x483000(_0x4c7d93),_0x2a8694=null);}catch(_0x3265d1){}await db['exec']('\x0a\x20\x20\x20\x20\x20\x20\x20\x20CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20scheduler_settings\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20chat_jid\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20enabled\x20INTEGER\x20DEFAULT\x201,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20timezone\x20TEXT\x0a\x20\x20\x20\x20\x20\x20\x20\x20);\x0a\x20\x20\x20\x20\x20\x20'),info('[sched]\x20schedules\x20table\x20appears\x20canonical/adequate');return;}info(_0x2ea2e2['LZIpq']);const _0x22d8b8=await readAndNormalizeExistingSchedules();await db['exec']('PRAGMA\x20foreign_keys\x20=\x20OFF;');try{await db[_0x2a84c8(0x1fa)]('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20schedules_new\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20id\x20INTEGER\x20PRIMARY\x20KEY\x20AUTOINCREMENT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20chat_jid\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20message\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20time\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20send_at\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20frequency\x20TEXT\x20DEFAULT\x20\x27daily\x27,\x0a\x20\x20\x20\x20\x20\x20\x20\x20timezone\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20last_sent\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20creator_jid\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20enabled\x20INTEGER\x20DEFAULT\x201,\x0a\x20\x20\x20\x20\x20\x20\x20\x20created_at\x20INTEGER\x20DEFAULT\x20(strftime(\x27%s\x27,\x27now\x27))\x0a\x20\x20\x20\x20\x20\x20);');}catch(_0xb0e5d9){await db['exec']('CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20schedules_new\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20id\x20INTEGER\x20PRIMARY\x20KEY\x20AUTOINCREMENT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20chat_jid\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20message\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20time\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20send_at\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20frequency\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20timezone\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20last_sent\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20creator_jid\x20TEXT\x20NOT\x20NULL,\x0a\x20\x20\x20\x20\x20\x20\x20\x20enabled\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20created_at\x20INTEGER\x0a\x20\x20\x20\x20\x20\x20);'),_0x2ea2e2['qxFVt'](warn,'[sched]\x20created\x20schedules_new\x20without\x20defaults\x20as\x20fallback');}const _0x4ae0f0=await db['prepare']('INSERT\x20INTO\x20schedules_new\x20(chat_jid,\x20message,\x20time,\x20send_at,\x20frequency,\x20timezone,\x20last_sent,\x20creator_jid,\x20enabled,\x20created_at)\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)');try{for(const _0x2b4345 of _0x22d8b8){try{await _0x4ae0f0['run'](_0x2b4345['chat_jid']||'',_0x2b4345['message']||'',_0x2b4345[_0x2a84c8(0x1ec)]||null,_0x2b4345['send_at']||null,_0x2b4345['frequency']||_0x2a84c8(0x1bd),_0x2b4345['timezone']||null,_0x2b4345['last_sent']||0x0,_0x2b4345['creator_jid']||'',0x1,_0x2b4345['created_at']||Math['floor'](_0x2ea2e2['ZCUBL'](Date[_0x2a84c8(0x1ff)](),0x3e8)));}catch(_0x5ba31d){warn('[sched]\x20cannot\x20insert\x20normalized\x20schedule\x20for\x20'+_0x2b4345[_0x2a84c8(0x1bc)]+':\x20'+(_0x5ba31d?.['message']||_0x5ba31d));}}}finally{try{await _0x4ae0f0[_0x2a84c8(0x1cf)]();}catch(_0x589aae){}}try{const _0x1a8b60=_0x2ea2e2['mQKwj']('schedules_backup_',Math[_0x2a84c8(0x208)](Date['now']()/0x3e8));await db['exec']('ALTER\x20TABLE\x20schedules\x20RENAME\x20TO\x20'+_0x1a8b60+';'),await db['exec']('ALTER\x20TABLE\x20schedules_new\x20RENAME\x20TO\x20schedules;');try{await db['exec']('CREATE\x20INDEX\x20IF\x20NOT\x20EXISTS\x20idx_schedules_chat\x20ON\x20schedules(chat_jid);');}catch(_0x53c10c){}info('[sched]\x20migration\x20done;\x20old\x20table\x20renamed\x20to\x20backup');}catch(_0x409f1f){warn('[sched]\x20swap\x20tables\x20failed:\x20'+(_0x409f1f?.['message']||_0x409f1f));throw _0x409f1f;}finally{await db['exec']('PRAGMA\x20foreign_keys\x20=\x20ON;');}await db['exec']('\x0a\x20\x20\x20\x20\x20\x20CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20scheduler_settings\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20chat_jid\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20enabled\x20INTEGER\x20DEFAULT\x201,\x0a\x20\x20\x20\x20\x20\x20\x20\x20timezone\x20TEXT\x0a\x20\x20\x20\x20\x20\x20);\x0a\x20\x20\x20\x20');}catch(_0x2dd2da){error(_0x2dd2da,'[sched]\x20ensureSchema\x20fatal');throw _0x2dd2da;}}function refreshConfig(){try{const _0x1c7e9d=getConfig()||{};CHECK_INTERVAL_MS=Number(_0x1c7e9d['SCHED_CHECK_INTERVAL_MS']??CHECK_INTERVAL_MS),DEFAULT_TIMEZONE=_0x1c7e9d['SCHED_DEFAULT_TIMEZONE']||DEFAULT_TIMEZONE,SEND_RETRIES=Number(_0x1c7e9d['SCHED_SEND_RETRIES']??SEND_RETRIES),INITIAL_BACKOFF_MS=Number(_0x1c7e9d['SCHED_INITIAL_BACKOFF_MS']??INITIAL_BACKOFF_MS),info('[sched]\x20config\x20refreshed:\x20interval='+CHECK_INTERVAL_MS+'ms\x20defaultTZ='+DEFAULT_TIMEZONE);}catch(_0x4e27e9){warn('[sched]\x20refreshConfig\x20error:\x20'+(_0x4e27e9?.['message']||_0x4e27e9));}}try{typeof hotReloadConfig==='function'&&hotReloadConfig((_0x5bb556=[])=>{const _0x2c845b={'qOqEA':function(_0x55387b){return _0x55387b();}};try{_0x2c845b['qOqEA'](refreshConfig);}catch(_0x264f92){warn('[sched]\x20hotReload\x20handler\x20error:\x20'+(_0x264f92?.['message']||_0x264f92));}});}catch(_0x4850d5){warn('[sched]\x20hotReloadConfig\x20registration\x20failed:\x20'+(_0x4850d5?.['message']||_0x4850d5));}refreshConfig();function tryBuildSendApiFromBot(_0x2908b9){const _0x2ebdc0=_0x336f8e;if(!_0x2908b9)return null;if(typeof _0x2908b9[_0x2ebdc0(0x213)]==='function')return async(_0x3dd174,_0x167066)=>_0x2908b9['sendMessage'](_0x3dd174,_0x167066);else{if(_0x2908b9['sock']&&typeof _0x2908b9['sock']['sendMessage']==='function')return async(_0x122f48,_0x9b46ce)=>_0x2908b9['sock']['sendMessage'](_0x122f48,_0x9b46ce);}return null;}function setupSendApi(_0x29b5c8){const _0x24797d=_0x336f8e;botRef=_0x29b5c8,sendApi=tryBuildSendApiFromBot(botRef),lastSockIdentity=botRef?.[_0x24797d(0x225)]||null,info('[sched]\x20setupSendApi\x20done;\x20sendApi\x20'+(sendApi?'available':'not-available'));}function startAttachWatcher(){stopAttachWatcher(),attachWatcherInterval=setInterval(()=>{try{if(!botRef)return;!lastSockIdentity&&botRef['sock']&&(setupSendApi(botRef),info('[sched]\x20attachWatcher:\x20setupSendApi\x20run'));}catch(_0x4b7bdd){warn('[sched]\x20attachWatcher\x20error:\x20'+(_0x4b7bdd?.['message']||_0x4b7bdd));}},0xbb8);}function stopAttachWatcher(){attachWatcherInterval&&(clearInterval(attachWatcherInterval),attachWatcherInterval=null);}function startSockMonitor(){stopSockMonitor(),sockMonitorInterval=setInterval(()=>{const _0xf75edf=_0x4cce;try{if(!botRef)return;const _0x2e75fd=botRef['sock']||null;if(_0x2e75fd&&lastSockIdentity&&_0x2e75fd!==lastSockIdentity){info('[sched]\x20detected\x20botRef.sock\x20change\x20-\x20re-setup\x20sendApi');try{setupSendApi(botRef);}catch(_0x5a3c0c){}}else!lastSockIdentity&&_0x2e75fd&&setupSendApi(botRef);}catch(_0x1e5d6f){warn(_0xf75edf(0x205)+(_0x1e5d6f?.['message']||_0x1e5d6f));}},0x3e8);}function stopSockMonitor(){sockMonitorInterval&&(clearInterval(sockMonitorInterval),sockMonitorInterval=null);}function startConnectionUpdateHook(){const _0x3c29e1=_0x336f8e,_0x410fa5={'cNqUh':'[sched]\x20connection.update\x20observed\x20-\x20re-setup\x20sendApi','Jzweo':'connection.update','vTkpa':function(_0x6a36b7,_0x391b32){return _0x6a36b7+_0x391b32;}};if(!botRef||!botRef['sock']||!botRef[_0x3c29e1(0x225)]['ev'])return;if(connectionUpdateHandler)return;connectionUpdateHandler=_0xeac077=>{const _0x108eaf=_0x3c29e1;try{setTimeout(()=>{try{info(_0x410fa5['cNqUh']),setupSendApi(botRef);}catch(_0x5e2ba7){}},0x1f4);}catch(_0x3a326c){warn(_0x108eaf(0x22d)+(_0x3a326c?.[_0x108eaf(0x1e9)]||_0x3a326c));}};try{botRef['sock']['ev']['on']?.(_0x410fa5['Jzweo'],connectionUpdateHandler);}catch(_0x46f3cc){if('KppSC'!==_0x3c29e1(0x1b9))warn(_0x410fa5['vTkpa']('[sched]\x20failed\x20to\x20hook\x20connection.update:\x20',_0x46f3cc?.['message']||_0x46f3cc));else return async(_0x3742f3,_0x4bc748)=>_0x98ae2b[_0x3c29e1(0x213)](_0x3742f3,_0x4bc748);}}function stopConnectionUpdateHook(){const _0x1e5caf=_0x336f8e;try{if('DTXvu'==='DTXvu'){if(connectionUpdateHandler&&botRef&&botRef['sock']&&botRef[_0x1e5caf(0x225)]['ev'])try{botRef['sock']['ev']['off']?.('connection.update',connectionUpdateHandler);}catch(_0x5b20eb){try{botRef['sock']['ev']['removeListener']?.(_0x1e5caf(0x1d3),connectionUpdateHandler);}catch(_0x54307c){}}}else{const _0x35c710=['chat_jid','chatid','chat_id','jid','chat',_0x1e5caf(0x1fd),'target_jid'];for(const _0x491729 of _0x35c710)if(_0x491729 in _0x1fd271&&_0x448099[_0x491729])return _0x35a421(_0x5c878e[_0x491729]);for(const _0x10980a of _0x588870['keys'](_0x333787)){const _0x3a37cb=_0x30338d[_0x10980a];if(typeof _0x3a37cb==='string'&&_0x3a37cb['includes']('@'))return _0x3a37cb;}return null;}}catch(_0xd410e9){}connectionUpdateHandler=null;}async function sendWithRetry(_0x33bb73,_0x33af8d){const _0x54c696=_0x336f8e,_0x260348={'fugWL':'no\x20sendApi\x20available'},_0x85f3c5=Number(SEND_RETRIES||0x3);let _0x5d73c7=0x0,_0x330cba=Number(INITIAL_BACKOFF_MS||0x1f4);while(_0x5d73c7<_0x85f3c5){try{const _0x1f9e5d=_0x33bb73||botRef?.[_0x54c696(0x225)]?.['user']?.['id']||null;if(!_0x1f9e5d)throw new Error('no\x20send\x20target\x20available');if(typeof sendApi==='function')return await sendApi(_0x1f9e5d,_0x33af8d),!![];if(botRef&&typeof botRef['sendMessage']==='function')return await botRef['sendMessage'](_0x1f9e5d,_0x33af8d),!![];if(botRef&&botRef['sock']&&typeof botRef['sock']['sendMessage']==='function')return await botRef[_0x54c696(0x225)][_0x54c696(0x213)](_0x1f9e5d,_0x33af8d),!![];throw new Error(_0x260348[_0x54c696(0x1c3)]);}catch(_0x559241){_0x5d73c7++;const _0x3a6b25=String(_0x559241?.['message']||'')['toLowerCase']()['includes']('rate')||_0x559241?.[_0x54c696(0x1bf)]===0x1ad;warn('[sched]\x20send\x20attempt\x20'+_0x5d73c7+'\x20failed:\x20'+(_0x559241?.['message']||_0x559241));if(_0x5d73c7>=_0x85f3c5||!_0x3a6b25)return![];await new Promise(_0x29a294=>setTimeout(_0x29a294,_0x330cba)),_0x330cba*=0x2;try{setupSendApi(botRef);}catch(_0x27694e){}}}return![];}function parseTimeToken(_0x1a3fe5,_0x49a1a5=DEFAULT_TIMEZONE){const _0x1450a2=_0x336f8e;if(!_0x1a3fe5||typeof _0x1a3fe5!=='string')return null;const _0x2010c9=_0x1a3fe5['trim'](),_0x41d640=_0x2010c9[_0x1450a2(0x1df)](/^in\s+(\d+)\s*(minute|min|minutes|m|hour|hours|hr|h|day|days|d)$/i);if(_0x41d640){if(_0x1450a2(0x1d4)==='fbUIb'){const _0x3bc033=Number(_0x41d640[0x1]),_0x2d962b=_0x41d640[0x2]['toLowerCase']();let _0x27f9c2=DateTime['now']()[_0x1450a2(0x1b4)](_0x49a1a5);if(_0x2d962b['startsWith'](_0x1450a2(0x217))||_0x2d962b==='m')_0x27f9c2=_0x27f9c2['plus']({'minutes':_0x3bc033});else{if(_0x2d962b['startsWith']('h')||_0x2d962b[_0x1450a2(0x1ef)]('hr'))_0x27f9c2=_0x27f9c2['plus']({'hours':_0x3bc033});else{if(_0x2d962b['startsWith']('d'))_0x27f9c2=_0x27f9c2[_0x1450a2(0x1d1)]({'days':_0x3bc033});}}if(_0x27f9c2['isValid'])return{'type':_0x1450a2(0x1c0),'dt':_0x27f9c2};}else _0x23fb58(0x0);}if(/^\d{4}-\d{2}-\d{2}[ T]\d{1,2}:\d{2}$/['test'](_0x2010c9)){const _0x521617=_0x2010c9['replace']('\x20','T'),_0x35eeb4=DateTime[_0x1450a2(0x1e1)](_0x521617,{'zone':_0x49a1a5});if(_0x35eeb4['isValid'])return{'type':_0x1450a2(0x1c0),'dt':_0x35eeb4};}if(/^\d{1,2}:\d{2}$/['test'](_0x2010c9)){const [_0x4620f4,_0x4c624a]=_0x2010c9['split'](':')['map'](Number);if(Number[_0x1450a2(0x1fb)](_0x4620f4)&&Number['isInteger'](_0x4c624a)&&_0x4620f4>=0x0&&_0x4620f4<=0x17&&_0x4c624a>=0x0&&_0x4c624a<=0x3b)return{'type':'hhmm','hhmm':String(_0x4620f4)['padStart'](0x2,'0')+':'+String(_0x4c624a)['padStart'](0x2,'0')};}return null;}function shouldSendSlot(_0x4a580c,_0x437146){const _0x2a78d0=_0x336f8e,_0xb99e5b=_0x4a580c['frequency']||'daily',_0x12a57f=_0x4a580c['last_sent']||0x0,_0x4b9ee8=_0x12a57f?DateTime['fromMillis'](_0x12a57f*0x3e8)['setZone'](_0x437146['zone']):null;if(!_0x4b9ee8)return!![];if(_0xb99e5b===_0x2a78d0(0x1bd))return!_0x4b9ee8['hasSame'](_0x437146,_0x2a78d0(0x201));if(_0xb99e5b==='weekly')return _0x437146['diff'](_0x4b9ee8,'days')['days']>=0x7;if(_0xb99e5b['startsWith']('every_n_days:')){const _0x4de65b=parseInt(_0xb99e5b['split'](':')[0x1],0xa);if(isNaN(_0x4de65b)||_0x4de65b<0x1)return![];return _0x437146['diff'](_0x4b9ee8,'days')['days']>=_0x4de65b;}if(_0xb99e5b[_0x2a78d0(0x1ef)]('days_of_week:')){const _0xd03a56=_0xb99e5b['split'](':')[0x1]['split'](',')['map'](_0x2f9a2e=>parseInt(_0x2f9a2e,0xa))[_0x2a78d0(0x1dd)](Boolean);return _0xd03a56['includes'](_0x437146['weekday'])&&!_0x4b9ee8['hasSame'](_0x437146,'day');}if(_0xb99e5b['startsWith']('day_of_month:')){const _0xf889f2=parseInt(_0xb99e5b[_0x2a78d0(0x1fc)](':')[0x1],0xa);return _0x437146['day']===_0xf889f2&&!_0x4b9ee8['hasSame'](_0x437146,'day');}return![];}async function addScheduleRow(_0x504c41){const _0xf00a6e=_0x336f8e;try{const _0x2e85b8=await db['run']('INSERT\x20INTO\x20schedules\x20(chat_jid,\x20message,\x20time,\x20send_at,\x20frequency,\x20timezone,\x20creator_jid)\x0a\x20\x20\x20\x20\x20\x20\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)',[_0x504c41[_0xf00a6e(0x1bc)],_0x504c41['message'],_0x504c41['time'],_0x504c41[_0xf00a6e(0x1b7)],_0x504c41['frequency']||'daily',_0x504c41['timezone']||null,_0x504c41[_0xf00a6e(0x211)]]),_0x42697f=_0x2e85b8?.['lastID']||null;return info(_0xf00a6e(0x238)+_0x42697f+'\x20chat='+_0x504c41['chat_jid']+'\x20time='+(_0x504c41['time']||_0x504c41[_0xf00a6e(0x1b7)])),_0x42697f;}catch(_0x1f3a4d){return warn('[sched]\x20addScheduleRow\x20error:\x20'+(_0x1f3a4d?.['message']||_0x1f3a4d)),null;}}async function listSchedulesForChat(_0x4cdcff){const _0x4e60bb=_0x336f8e;try{const _0x4645b4=await db[_0x4e60bb(0x1d9)](_0x4e60bb(0x233),[_0x4cdcff]);return _0x4645b4||[];}catch(_0x71ad85){return warn('[sched]\x20listSchedulesForChat\x20error:\x20'+(_0x71ad85?.['message']||_0x71ad85)),[];}}async function removeScheduleByDBId(_0x45e8ee){const _0x3a8a97=_0x336f8e;try{const _0x39a4cf=await db['run']('DELETE\x20FROM\x20schedules\x20WHERE\x20id\x20=\x20?',[_0x45e8ee]);return _0x39a4cf?.['changes']?!![]:![];}catch(_0x33dcf7){return warn('[sched]\x20removeScheduleByDBId\x20error:\x20'+(_0x33dcf7?.[_0x3a8a97(0x1e9)]||_0x33dcf7)),![];}}async function removeAllSchedulesForChat(_0x4739cb){const _0x585aaa=_0x336f8e;try{const _0x384729=await db[_0x585aaa(0x215)]('DELETE\x20FROM\x20schedules\x20WHERE\x20chat_jid\x20=\x20?',[_0x4739cb]);return _0x384729?.['changes']||0x0;}catch(_0x1fdcb3){return warn('[sched]\x20removeAllSchedulesForChat\x20error:\x20'+(_0x1fdcb3?.[_0x585aaa(0x1e9)]||_0x1fdcb3)),0x0;}}async function updateScheduleFields(_0x24a367,_0x11c44e={}){const _0x1d49d3=_0x336f8e;try{const _0x3c25a5=[],_0xcacdae=[];for(const _0xb60575 of Object['keys'](_0x11c44e)){_0x3c25a5['push'](_0xb60575+_0x1d49d3(0x1db)),_0xcacdae['push'](_0x11c44e[_0xb60575]);}if(!_0x3c25a5[_0x1d49d3(0x1b6)])return![];_0xcacdae['push'](_0x24a367);const _0x1eda9a='UPDATE\x20schedules\x20SET\x20'+_0x3c25a5['join'](',\x20')+_0x1d49d3(0x1cc),_0x520093=await db['run'](_0x1eda9a,_0xcacdae);return _0x520093?.[_0x1d49d3(0x22b)]?!![]:![];}catch(_0x3e4cf2){return warn('[sched]\x20updateScheduleFields\x20error:\x20'+(_0x3e4cf2?.[_0x1d49d3(0x1e9)]||_0x3e4cf2)),![];}}async function getChatTimezone(_0x1afc60){const _0x257722=_0x336f8e;try{const _0x9bed9b=await db['get'](_0x257722(0x1eb),[_0x1afc60]);return _0x9bed9b?.['timezone']||null;}catch(_0x43d786){return warn('[sched]\x20getChatTimezone\x20error:\x20'+(_0x43d786?.['message']||_0x43d786)),null;}}async function setChatTimezone(_0x26619c,_0x2045a4){const _0x7e31cf={'fIwce':function(_0x540f8c,_0x23ac20){return _0x540f8c+_0x23ac20;}};try{return await db['run']('INSERT\x20INTO\x20scheduler_settings\x20(chat_jid,\x20timezone)\x20VALUES\x20(?,\x20?)\x20ON\x20CONFLICT(chat_jid)\x20DO\x20UPDATE\x20SET\x20timezone=excluded.timezone',[_0x26619c,_0x2045a4]),!![];}catch(_0x622f2c){return warn(_0x7e31cf['fIwce']('[sched]\x20setChatTimezone\x20error:\x20',_0x622f2c?.['message']||_0x622f2c)),![];}}async function executorTick(){const _0x2699c1=_0x336f8e,_0x34e1f3={'jMhCP':function(_0x3ac6ad,_0x4603a0){return _0x3ac6ad===_0x4603a0;},'ijCSA':function(_0x266e37,_0x3a58ea,_0x28c8d9){return _0x266e37(_0x3a58ea,_0x28c8d9);},'DTAcL':function(_0x3bf1b9,_0x1be27b){return _0x3bf1b9!==_0x1be27b;},'EvjTC':function(_0x33de43,_0x24844b){return _0x33de43+_0x24844b;}};if(executorRunning)return;executorRunning=!![];try{const _0x1c66ab=await db[_0x2699c1(0x1d9)](_0x2699c1(0x1c1));if(!_0x1c66ab||_0x34e1f3['jMhCP'](_0x1c66ab['length'],0x0))return;for(const _0x273d3d of _0x1c66ab){try{const _0x10e7c2=_0x273d3d['timezone']||await getChatTimezone(_0x273d3d['chat_jid'])||DEFAULT_TIMEZONE,_0xf09ef8=DateTime['now']()['setZone'](_0x10e7c2);if(_0x273d3d[_0x2699c1(0x1b7)]&&Number(_0x273d3d['send_at'])>0x0){if('nIJVZ'==='nIJVZ'){const _0x39c149=Number(_0x273d3d['send_at']);if(_0x39c149<=Math['floor'](Date['now']()/0x3e8)){const _0x8c3de5=await _0x34e1f3['ijCSA'](sendWithRetry,_0x273d3d['chat_jid'],{'text':_0x273d3d['message']});_0x8c3de5?(await updateScheduleFields(_0x273d3d['id'],{'enabled':0x0,'last_sent':Math[_0x2699c1(0x208)](Date[_0x2699c1(0x1ff)]()/0x3e8)}),info('[sched]\x20delivered\x20one-off\x20id='+_0x273d3d['id']+'\x20to\x20'+_0x273d3d['chat_jid'])):warn('[sched]\x20failed\x20to\x20deliver\x20one-off\x20id='+_0x273d3d['id']+'\x20to\x20'+_0x273d3d['chat_jid']);}continue;}else{const _0x390593=_0x2eed1c['send_at']?_0x296f3d['fromMillis'](_0x34b8a2(_0x4f9e63['send_at'])*0x3e8)[_0x2699c1(0x1b4)](_0x307079['timezone']||_0x186ab9)['toISO']({'suppressSeconds':!![]}):_0x2a95cc['time']?_0x1b9788[_0x2699c1(0x1ec)]+'\x20('+(_0x4848cc[_0x2699c1(0x226)]||'group/default\x20TZ')+')':'unknown',_0x2c5141=(_0x5e5814['message']||'')[_0x2699c1(0x1fc)]('\x0a')[_0x2699c1(0x1f1)](_0x5e6afe=>_0x5e6afe['trimEnd']())['join']('\x0a');return _0x346049+0x1+')\x20id:'+_0x44c2d0['id']+'\x20when:'+_0x390593+_0x2699c1(0x1f8)+(_0x1fe5c3[_0x2699c1(0x21a)]||'daily')+_0x2699c1(0x216)+(_0x465d12[_0x2699c1(0x202)]?'yes':'no')+'\x0amsg:\x0a'+_0x2c5141;}}if(!_0x273d3d[_0x2699c1(0x1ec)])continue;const _0x49b6f4=_0xf09ef8['toFormat']('HH:mm');if(_0x34e1f3['DTAcL'](_0x49b6f4,_0x273d3d['time']))continue;const _0x163711={'id':_0x273d3d['id'],'frequency':_0x273d3d[_0x2699c1(0x21a)]||'daily','last_sent':_0x273d3d['last_sent']||0x0};if(!shouldSendSlot(_0x163711,_0xf09ef8))continue;const _0x2cff17=await sendWithRetry(_0x273d3d['chat_jid'],{'text':_0x273d3d['message']});_0x2cff17?(await updateScheduleFields(_0x273d3d['id'],{'last_sent':Math['floor'](Date['now']()/0x3e8)}),info(_0x2699c1(0x1d5)+_0x273d3d['id']+'\x20to\x20'+_0x273d3d['chat_jid']+'\x20at\x20'+_0x273d3d['time']+'\x20('+_0x10e7c2+')')):warn('[sched]\x20failed\x20to\x20deliver\x20recurring\x20id='+_0x273d3d['id']+'\x20to\x20'+_0x273d3d['chat_jid']+'\x20at\x20'+_0x273d3d['time']);}catch(_0xe4e0f4){warn(_0x2699c1(0x1e4)+(_0xe4e0f4?.['message']||_0xe4e0f4));}}}catch(_0x309f36){error(_0x34e1f3['EvjTC']('[sched]\x20executorTick\x20error:\x20',_0x309f36?.['message']||_0x309f36));}finally{executorRunning=![];}}function startSchedulerAligned(){const _0x310a3a={'dOOJV':function(_0xe3b7f5){return _0xe3b7f5();},'ivGUa':function(_0x1d15aa,_0x525b05){return _0x1d15aa-_0x525b05;}};stopScheduler();const _0x5d7264=_0x310a3a['ivGUa'](0xea60,Date['now']()%0xea60);setTimeout(()=>{const _0x2d7960=_0x4cce,_0x4d7009={'lNPrn':function(_0x4aa8e1){return _0x310a3a['dOOJV'](_0x4aa8e1);}};if('fEtqF'===_0x2d7960(0x1c7)){const _0x3cb10d={'tFbnb':function(_0x2d30e4){return _0x2d30e4();}};_0x4d7009['lNPrn'](_0x229e80);const _0x4de626=0xea60-_0x5e1dfc['now']()%0xea60;_0x48ecd2(()=>{const _0x2ebd86=_0x2d7960;_0x4e50f6()[_0x2ebd86(0x22c)](_0x477fcc=>_0x4f8d53('[sched]\x20initial\x20executor\x20error:\x20'+(_0x477fcc?.[_0x2ebd86(0x1e9)]||_0x477fcc))),_0x5f1aa3=_0x1c0481(()=>{_0x3cb10d['tFbnb'](_0x4be64c)['catch'](_0x390f37=>_0x1bcdd2('[sched]\x20executorTick\x20error:\x20'+(_0x390f37?.['message']||_0x390f37)));},_0x3d182b),_0xe2bc41('[sched]\x20scheduler\x20started\x20(aligned\x20to\x20minutes)');},_0x4de626);}else executorTick()['catch'](_0xad1b5f=>warn('[sched]\x20initial\x20executor\x20error:\x20'+(_0xad1b5f?.['message']||_0xad1b5f))),schedulerIntervalHandle=setInterval(()=>{const _0x17df2a=_0x2d7960;executorTick()['catch'](_0x4329d4=>warn(_0x17df2a(0x23a)+(_0x4329d4?.[_0x17df2a(0x1e9)]||_0x4329d4)));},CHECK_INTERVAL_MS),info('[sched]\x20scheduler\x20started\x20(aligned\x20to\x20minutes)');},_0x5d7264);}function stopScheduler(){const _0x5da061=_0x336f8e,_0x35b4cc={'HEuJF':'YMPzv','WzCLV':function(_0x4c6927,_0x5b5485){return _0x4c6927(_0x5b5485);}};if(schedulerIntervalHandle){if('YMPzv'===_0x35b4cc['HEuJF'])_0x35b4cc['WzCLV'](clearInterval,schedulerIntervalHandle),schedulerIntervalHandle=null,info('[sched]\x20scheduler\x20stopped');else return _0x49017b('[sched]\x20removeAllSchedulesForChat\x20error:\x20'+(_0x32f02e?.[_0x5da061(0x1e9)]||_0x24de25)),0x0;}}function extractTextFromMessage(_0x573c49){const _0x2706db=_0x336f8e;if(!_0x573c49||!_0x573c49['message'])return'';const _0x466713=_0x573c49['message'];if(_0x466713['conversation'])return _0x466713['conversation'];if(_0x466713['extendedTextMessage']?.['text'])return _0x466713['extendedTextMessage']['text'];if(_0x466713[_0x2706db(0x1be)]?.['caption'])return _0x466713['imageMessage']['caption'];if(_0x466713[_0x2706db(0x1c8)]?.['caption'])return _0x466713['videoMessage']['caption'];if(_0x466713[_0x2706db(0x214)]?.[_0x2706db(0x1bb)])return _0x466713['buttonsResponseMessage']['selectedButtonId'];if(_0x466713['listResponseMessage']?.['singleSelectReply']?.['selectedRowId'])return _0x466713[_0x2706db(0x20b)]['singleSelectReply']['selectedRowId'];return'';}const USAGE='Usage:\x0asched\x20help\x0asched\x20add\x20<HH:mm|YYYY-MM-DDTHH:mm|in\x20N\x20hours/days/minutes>\x20<message...>\x0a\x20\x20(message\x20may\x20be\x20on\x20same\x20line\x20after\x20time\x20or\x20on\x20following\x20lines;\x20original\x20newlines\x20preserved)\x0asched\x20once\x20<HH:mm>\x20[Ndays]\x20<message...>\x20\x20\x20->\x20one-off;\x20if\x20Ndays\x20provided\x20schedule\x20for\x20today+Ndays\x20at\x20HH:mm\x20(N\x20>=\x201)\x0asched\x20list\x0asched\x20delete\x20<number|number,number,...|all>\x0asched\x20edit\x20<number>\x20<HH:mm|in\x20N\x20hours|YYYY-MM-DDTHH:mm>\x0asched\x20frequency\x20<number>\x20<n>\x20\x20\x20(n=1\x20daily,\x20n=2\x20every\x202\x20days,\x20etc.)\x0asched\x20disable\x20<number>\x0asched\x20enable\x20<number>\x0a',processedCmdKeys=new Map(),CMD_DEDUPE_TTL_MS=0x14*0x3e8;function markCmdProcessed(_0x1338c2){if(!_0x1338c2)return;if(processedCmdKeys['has'](_0x1338c2))try{clearTimeout(processedCmdKeys['get'](_0x1338c2));}catch(_0x52093d){}const _0x7f4ea1=setTimeout(()=>processedCmdKeys['delete'](_0x1338c2),CMD_DEDUPE_TTL_MS);processedCmdKeys['set'](_0x1338c2,_0x7f4ea1);}function isCmdProcessed(_0x5ed159){return _0x5ed159&&processedCmdKeys['has'](_0x5ed159);}async function resolveDefaultChatForUser(_0xc6005a){const _0x1a535f=_0x336f8e,_0x34d83a={'PLIRM':function(_0x2f6a94,_0x5d55de){return _0x2f6a94+_0x5d55de;}};try{const _0x2f3069=await getDefault(_0xc6005a)['catch'](()=>null);if(!_0x2f3069)return null;if(String(_0x2f3069)['includes']('@'))return _0x2f3069;const _0x2e8d05=await getConnection(_0x2f3069)[_0x1a535f(0x22c)](()=>null);return _0x2e8d05||null;}catch(_0x3f7254){return warn(_0x34d83a[_0x1a535f(0x222)]('[sched]\x20resolveDefaultChatForUser\x20error:\x20',_0x3f7254?.['message']||_0x3f7254)),null;}}async function resolveNumberToDbId(_0x2a54a9,_0x3fff77){const _0x2a7023=_0x336f8e,_0xf8078={'BcxgA':function(_0x5703c3,_0x44254e){return _0x5703c3-_0x44254e;}};if(!_0x2a54a9||!Number['isInteger'](_0x2a54a9)||_0x2a54a9<0x1)return null;const _0x38a490=await resolveDefaultChatForUser(_0x3fff77);if(!_0x38a490)return null;const _0x32e4fc=await listSchedulesForChat(_0x38a490);if(!_0x32e4fc||_0x32e4fc['length']<_0x2a54a9)return null;return _0x32e4fc[_0xf8078[_0x2a7023(0x1d0)](_0x2a54a9,0x1)]['id'];}function splitFirstLinePreserveRest(_0x72033){const _0x16f3c3=_0x336f8e,_0xd303e0=_0x72033[_0x16f3c3(0x1fc)](/\r?\n/),_0x27e22c=_0xd303e0['length']>0x0?_0xd303e0['shift']():'',_0x10074f=_0xd303e0[_0x16f3c3(0x1f6)]('\x0a'),_0x50af51=_0x27e22c['trim']()[_0x16f3c3(0x1fc)](/\s+/)['filter'](Boolean);return{'firstLine':_0x27e22c,'restText':_0x10074f,'firstTokens':_0x50af51};}export async function onMessage(_0xefd9f){const _0x4ec920=_0x336f8e,_0x568a8b={'ISNkh':function(_0x191c88,_0x3341e4){return _0x191c88(_0x3341e4);},'PoeYA':function(_0x221b9d,_0x2dd0c3){return _0x221b9d(_0x2dd0c3);},'ZksIJ':_0x4ec920(0x1ba),'whyVx':function(_0x388b59,_0x30ec05){return _0x388b59+_0x30ec05;},'kRpmn':function(_0xef0ae9,_0xa8d030){return _0xef0ae9+_0xa8d030;},'yjMuA':function(_0x59e387,_0x3c3be8){return _0x59e387===_0x3c3be8;},'GzfJW':function(_0x3bb137,_0x2c6efd){return _0x3bb137/_0x2c6efd;},'yudJj':'Failed\x20to\x20create\x20one-off\x20schedule.','DDGIz':function(_0x494f9e,_0xbc4fbc){return _0x494f9e&&_0xbc4fbc;},'xyCaw':function(_0xe6dac7,_0x49b81d){return _0xe6dac7===_0x49b81d;},'AAhKL':'datetime','DglKf':function(_0x214c05,_0x2d1157,_0x157e99){return _0x214c05(_0x2d1157,_0x157e99);},'hWQFQ':'No\x20valid\x20indexes\x20provided.\x20Usage:\x20sched\x20delete\x201\x202\x203\x20OR\x20sched\x20delete\x201,2,3\x20OR\x20sched\x20delete\x20all','AanUJ':_0x4ec920(0x204),'SmILx':function(_0x32f1d8,_0x4795a0){return _0x32f1d8(_0x4795a0);},'YuMnd':'Unsupported\x20time\x20format\x20for\x20edit.','HfMDn':function(_0xd7b351,_0x57f15a){return _0xd7b351<_0x57f15a;}};try{if(!_0xefd9f||!_0xefd9f[_0x4ec920(0x20c)]||!_0xefd9f['message'])return;const _0x2b3f6a=String(_0xefd9f['key']['remoteJid']||'')+'::'+String(_0xefd9f['key']['id']||_0xefd9f['key'][_0x4ec920(0x1d8)]||'');if(isCmdProcessed(_0x2b3f6a))return;markCmdProcessed(_0x2b3f6a);if(!_0xefd9f[_0x4ec920(0x236)])return;const _0x3fca5d=_0xefd9f[_0x4ec920(0x20c)][_0x4ec920(0x207)],_0x30fe09=typeof _0x3fca5d==='string'&&_0x3fca5d['endsWith'](_0x4ec920(0x1c2));if(!_0x30fe09)return;let _0x5f04a9=![];try{_0x5f04a9=await isadmin(botRef,_0xefd9f);}catch(_0x562875){warn(_0x568a8b[_0x4ec920(0x1c6)]),_0x5f04a9=![];}if(!_0x5f04a9)return;const _0x18200e=typeof _0xefd9f[_0x4ec920(0x1cd)]==='string'&&_0xefd9f['text']['trim']()[_0x4ec920(0x1b6)]?_0xefd9f['text']:extractTextFromMessage(_0xefd9f)||'';if(!_0x18200e)return;const _0x1530fd=String(_0x18200e)[_0x4ec920(0x1e3)](),{firstLine:_0x21dced,restText:_0x1cfe1d,firstTokens:_0x56bc4f}=splitFirstLinePreserveRest(_0x1530fd),_0x33cdbf=(_0x56bc4f[0x0]||'')[_0x4ec920(0x23b)]();if(!commands['includes'](_0x33cdbf))return;const _0x4c3458=(_0x56bc4f[0x1]||'')['toLowerCase'](),_0x190042=_0xefd9f['key'][_0x4ec920(0x1d8)]||_0xefd9f['key']['from']||_0xefd9f[_0x4ec920(0x20c)][_0x4ec920(0x207)]||'',_0x7ad855=(_0x190042||'')['split']('@')[0x0],_0x5eeec2=await resolveDefaultChatForUser(_0x7ad855),_0x5b66a3=_0x3fca5d;if(!_0x5eeec2){await sendWithRetry(_0x5b66a3,{'text':'Could\x20not\x20resolve\x20default\x20connection\x20for\x20user\x20'+_0x7ad855+'.\x20Set\x20default\x20with\x20/setdefault.'});return;}if(!_0x4c3458||_0x4c3458==='help'){await sendWithRetry(_0x5b66a3,{'text':USAGE});return;}if(_0x4c3458==='once'){const _0x4d86e9=_0x56bc4f[0x2],_0x5315e3=_0x56bc4f[0x3]&&/^\d+$/['test'](_0x56bc4f[0x3])?_0x568a8b['PoeYA'](Number,_0x56bc4f[0x3]):null;let _0x3a1643='';if(_0x4d86e9){if(_0x4ec920(0x21f)!=='UYLTj'){const _0x410a5d=new RegExp('\x5cb'+_0x4d86e9['replace'](/[.*+?^${}()|[\\]\\\\]/g,'\x5c$&')+'\x5cb'),_0x481ba0=_0x21dced['match'](_0x410a5d);if(_0x481ba0){const _0x5ad427=_0x21dced['indexOf'](_0x481ba0[0x0]),_0x529588=_0x568a8b[_0x4ec920(0x227)](_0x5ad427,_0x481ba0[0x0]['length']);_0x3a1643=_0x21dced['slice'](_0x529588)['replace'](/^\s*/,'');if(_0x3a1643&&/^\d+/['test'](_0x3a1643))_0x3a1643=_0x3a1643[_0x4ec920(0x1ce)](/^\d+\s*/,'');}}else _0x393754(_0x4ec920(0x21d)+(_0x106023?.['message']||_0x278a3b));}const _0x3ded29=_0x3a1643&&_0x1cfe1d?_0x568a8b['kRpmn'](_0x568a8b['kRpmn'](_0x3a1643,'\x0a'),_0x1cfe1d):_0x3a1643||_0x1cfe1d||'';if(!_0x4d86e9||!_0x3ded29||_0x3ded29[_0x4ec920(0x1e3)]()['length']===0x0){await sendWithRetry(_0x5b66a3,{'text':'Usage:\x20sched\x20once\x20<HH:mm>\x20[Ndays]\x20<message...>'});return;}const _0x38eb8c=parseTimeToken(_0x4d86e9,await getChatTimezone(_0x5eeec2)||DEFAULT_TIMEZONE);if(!_0x38eb8c){await sendWithRetry(_0x5b66a3,{'text':'Failed\x20to\x20parse\x20time.\x20Use\x20HH:mm\x20or\x20ISO\x20datetime.'});return;}const _0x7b21b8=await getChatTimezone(_0x5eeec2)||DEFAULT_TIMEZONE,_0x7a09cb=DateTime['now']()['setZone'](_0x7b21b8);if(_0x568a8b[_0x4ec920(0x1e8)](_0x38eb8c['type'],'datetime')){const _0x26143a=_0x38eb8c['dt'];let _0x1af794=Math['floor'](_0x568a8b['GzfJW'](_0x26143a['toMillis'](),0x3e8));const _0x5e31b7=await addScheduleRow({'chat_jid':_0x5eeec2,'message':_0x3ded29,'time':null,'send_at':_0x1af794,'frequency':'once','timezone':_0x26143a['zoneName']||_0x7b21b8,'creator_jid':_0x190042});if(_0x5e31b7)await sendWithRetry(_0x5b66a3,{'text':'One-off\x20scheduled\x20#'+_0x5e31b7+'\x20for\x20'+_0x26143a['toLocaleString'](DateTime['DATETIME_MED'])+'\x20('+_0x26143a[_0x4ec920(0x1f7)]+')\x20in\x20default\x20'+_0x5eeec2});else await sendWithRetry(_0x5b66a3,{'text':_0x4ec920(0x1f3)});return;}if(_0x38eb8c['type']==='hhmm'){const [_0x22b5a5,_0x59a755]=_0x38eb8c['hhmm']['split'](':')[_0x4ec920(0x1f1)](Number);let _0x3bc6d0=_0x7a09cb['startOf']('day')['set']({'hour':_0x22b5a5,'minute':_0x59a755,'second':0x0,'millisecond':0x0});if(_0x5315e3&&Number['isInteger'](_0x5315e3)&&_0x5315e3>=0x1)_0x3bc6d0=_0x3bc6d0['plus']({'days':Number(_0x5315e3)});else{if(_0x3bc6d0<=_0x7a09cb)_0x3bc6d0=_0x3bc6d0['plus']({'days':0x1});}const _0x2ea98c=Math['floor'](_0x3bc6d0['toMillis']()/0x3e8),_0x22c7d0=await addScheduleRow({'chat_jid':_0x5eeec2,'message':_0x3ded29,'time':null,'send_at':_0x2ea98c,'frequency':'once','timezone':_0x7b21b8,'creator_jid':_0x190042});if(_0x22c7d0)await sendWithRetry(_0x5b66a3,{'text':'One-off\x20scheduled\x20#'+_0x22c7d0+'\x20for\x20'+_0x3bc6d0['toLocaleString'](DateTime['DATETIME_MED'])+'\x20('+_0x7b21b8+')\x20in\x20default\x20'+_0x5eeec2});else await sendWithRetry(_0x5b66a3,{'text':_0x568a8b['yudJj']});return;}await sendWithRetry(_0x5b66a3,{'text':'Unsupported\x20time\x20format\x20for\x20once\x20scheduling.'});return;}if(_0x4c3458==='add'){if(!_0x56bc4f[0x2]){await sendWithRetry(_0x5b66a3,{'text':_0x4ec920(0x1c5)});return;}const _0x55c30b=_0x56bc4f[0x2],_0x5a4872=_0x56bc4f[0x3]&&/^\d+$/['test'](_0x56bc4f[0x3])?Number(_0x56bc4f[0x3]):null;let _0x4bb827='';const _0x3371d3=new RegExp('\x5cb'+_0x55c30b['replace'](/[.*+?^${}()|[\\]\\\\]/g,'\x5c$&')+'\x5cb'),_0x55fbb7=_0x21dced['match'](_0x3371d3);if(_0x55fbb7){const _0x4a7bd7=_0x21dced['indexOf'](_0x55fbb7[0x0]),_0x3fd6b8=_0x4a7bd7+_0x55fbb7[0x0]['length'];_0x4bb827=_0x21dced[_0x4ec920(0x23c)](_0x3fd6b8)['replace'](/^\s*/,'');if(_0x4bb827&&/^\d+/[_0x4ec920(0x22a)](_0x4bb827))_0x4bb827=_0x4bb827['replace'](/^\d+\s*/,'');}const _0x3f8fc1=_0x568a8b['DDGIz'](_0x4bb827,_0x1cfe1d)?_0x4bb827+'\x0a'+_0x1cfe1d:_0x4bb827||_0x1cfe1d||'';if(!_0x3f8fc1||_0x3f8fc1['trim']()[_0x4ec920(0x1b6)]===0x0){if('YThWw'==='aICmP')_0x3edb1f[_0x4ec920(0x225)]['ev']['on']?.(_0x4ec920(0x1d3),_0x4e9a0d);else{await sendWithRetry(_0x5b66a3,{'text':'Please\x20provide\x20message\x20text\x20(same\x20line\x20after\x20time\x20or\x20on\x20following\x20lines).'});return;}}const _0x36f780=parseTimeToken(_0x55c30b,await getChatTimezone(_0x5eeec2)||DEFAULT_TIMEZONE);if(!_0x36f780){if(_0x4ec920(0x212)==='qYjjO'){if(!_0x419ad9)return;if(_0x45d504[_0x4ec920(0x231)](_0x2f4bfb))try{_0x4ec6ce(_0x47a8e5[_0x4ec920(0x206)](_0x1ca9a9));}catch(_0x128953){}const _0x3bc95f=_0x38fbba(()=>_0x2e7e6a[_0x4ec920(0x21e)](_0x3613ba),_0x4e6308);_0x409ae9[_0x4ec920(0x1d7)](_0x16c1f5,_0x3bc95f);}else{await sendWithRetry(_0x5b66a3,{'text':'Failed\x20to\x20parse\x20time.\x20Use\x20HH:mm,\x20ISO\x20datetime,\x20or\x20\x22in\x20N\x20hours\x22.'});return;}}const _0x507c60=_0x190042,_0x229e70=await getChatTimezone(_0x5eeec2)||DEFAULT_TIMEZONE,_0x1911f3=DateTime['now']()['setZone'](_0x229e70);if(_0x568a8b[_0x4ec920(0x1e0)](_0x36f780['type'],_0x568a8b['AAhKL'])){const _0x3c7e76=_0x36f780['dt'],_0x5ea267=Math['floor'](_0x3c7e76[_0x4ec920(0x1e7)]()/0x3e8),_0x59fe63=await addScheduleRow({'chat_jid':_0x5eeec2,'message':_0x3f8fc1,'time':null,'send_at':_0x5ea267,'frequency':'once','timezone':_0x3c7e76['zoneName']||_0x229e70,'creator_jid':_0x507c60});if(_0x59fe63)await sendWithRetry(_0x5b66a3,{'text':'One-off\x20scheduled\x20#'+_0x59fe63+'\x20for\x20'+_0x3c7e76['toLocaleString'](DateTime[_0x4ec920(0x239)])+'\x20('+_0x3c7e76['zoneName']+_0x4ec920(0x1ee)+_0x5eeec2});else await sendWithRetry(_0x5b66a3,{'text':'Failed\x20to\x20create\x20one-off\x20schedule.'});return;}if(_0x36f780[_0x4ec920(0x1e2)]==='hhmm'){const _0x37e1cd=_0x36f780['hhmm'];if(_0x5a4872&&Number['isInteger'](_0x5a4872)&&_0x5a4872>=0x1){const [_0x298dda,_0x52ffed]=_0x37e1cd['split'](':')['map'](Number);let _0x28e4e3=_0x1911f3['startOf']('day')['set']({'hour':_0x298dda,'minute':_0x52ffed,'second':0x0,'millisecond':0x0});_0x28e4e3=_0x28e4e3[_0x4ec920(0x1d1)]({'days':Number(_0x5a4872)});const _0x185988=Math[_0x4ec920(0x208)](_0x28e4e3['toMillis']()/0x3e8),_0xee1da7=await addScheduleRow({'chat_jid':_0x5eeec2,'message':_0x3f8fc1,'time':null,'send_at':_0x185988,'frequency':'once','timezone':_0x229e70,'creator_jid':_0x507c60});if(_0xee1da7)await sendWithRetry(_0x5b66a3,{'text':'One-off\x20scheduled\x20#'+_0xee1da7+'\x20for\x20'+_0x28e4e3['toLocaleString'](DateTime['DATETIME_MED'])+'\x20('+_0x229e70+')\x20in\x20default\x20'+_0x5eeec2});else await sendWithRetry(_0x5b66a3,{'text':'Failed\x20to\x20create\x20one-off\x20schedule.'});return;}const _0x37fdb7=await addScheduleRow({'chat_jid':_0x5eeec2,'message':_0x3f8fc1,'time':_0x37e1cd,'send_at':null,'frequency':'daily','timezone':_0x229e70,'creator_jid':_0x507c60});if(_0x37fdb7)await sendWithRetry(_0x5b66a3,{'text':_0x4ec920(0x1da)+_0x37fdb7+'\x20at\x20'+_0x37e1cd+'\x20('+_0x229e70+')\x20in\x20default\x20'+_0x5eeec2});else await _0x568a8b['DglKf'](sendWithRetry,_0x5b66a3,{'text':'Failed\x20to\x20create\x20recurring\x20schedule.'});return;}await sendWithRetry(_0x5b66a3,{'text':_0x4ec920(0x1cb)});return;}if(_0x4c3458==='list'){const _0x4e39b8=await listSchedulesForChat(_0x5eeec2);if(!_0x4e39b8['length']){await sendWithRetry(_0x5b66a3,{'text':_0x4ec920(0x22f)+_0x5eeec2+'.'});return;}const _0x528f34=_0x4e39b8[_0x4ec920(0x1f1)]((_0xc8cdb7,_0x57a89a)=>{const _0x3c74fc=_0x4ec920,_0x157c65=_0xc8cdb7['send_at']?DateTime['fromMillis'](Number(_0xc8cdb7[_0x3c74fc(0x1b7)])*0x3e8)['setZone'](_0xc8cdb7['timezone']||DEFAULT_TIMEZONE)['toISO']({'suppressSeconds':!![]}):_0xc8cdb7['time']?_0xc8cdb7['time']+'\x20('+(_0xc8cdb7['timezone']||'group/default\x20TZ')+')':'unknown',_0x1c06d0=(_0xc8cdb7['message']||'')[_0x3c74fc(0x1fc)]('\x0a')['map'](_0x46119f=>_0x46119f['trimEnd']())['join']('\x0a');return _0x57a89a+0x1+')\x20id:'+_0xc8cdb7['id']+'\x20when:'+_0x157c65+'\x20freq:'+(_0xc8cdb7['frequency']||'daily')+'\x20enabled:'+(_0xc8cdb7[_0x3c74fc(0x202)]?'yes':'no')+'\x0amsg:\x0a'+_0x1c06d0;}),_0x1e1836='Scheduled\x20for\x20default\x20'+_0x5eeec2+':\x0a\x0a'+_0x528f34['join']('\x0a\x0a');await sendWithRetry(_0x5b66a3,{'text':_0x1e1836});return;}if(_0x4c3458==='delete'){const _0x5cf25d=_0x56bc4f['slice'](0x2);let _0x5bfe8f=_0x5cf25d['join']('\x20');if(!_0x5bfe8f&&_0x1cfe1d)_0x5bfe8f=_0x1cfe1d['trim']();if(!_0x5bfe8f){await sendWithRetry(_0x5b66a3,{'text':'Usage:\x20sched\x20delete\x20<number|number,number,...|all>'});return;}if(/^\s*all\s*$/i['test'](_0x5bfe8f)){if(_0x4ec920(0x20e)==='kySvR'){const _0x179c2a=_0x4a12ae()||{};_0x360344=_0x276e2c(_0x179c2a['SCHED_CHECK_INTERVAL_MS']??_0x50c368),_0x30f662=_0x179c2a['SCHED_DEFAULT_TIMEZONE']||_0x4352fd,_0x127e64=_0x568a8b['ISNkh'](_0x486e22,_0x179c2a['SCHED_SEND_RETRIES']??_0x518f2d),_0x2d82ae=_0x444667(_0x179c2a['SCHED_INITIAL_BACKOFF_MS']??_0x2479ab),_0x568a8b['PoeYA'](_0x2a11fa,'[sched]\x20config\x20refreshed:\x20interval='+_0x43140d+'ms\x20defaultTZ='+_0x11a57e);}else{const _0x5a4824=await removeAllSchedulesForChat(_0x5eeec2);await sendWithRetry(_0x5b66a3,{'text':_0x4ec920(0x218)+_0x5a4824+'\x20schedule(s)\x20for\x20default\x20'+_0x5eeec2+'.'});return;}}const _0x28fc21=_0x5bfe8f['split'](/[\s,]+/)['map'](_0xb8d504=>_0xb8d504['trim']())['filter'](Boolean),_0x1c4d23=_0x28fc21['map'](_0x3b3eeb=>Number(_0x3b3eeb))[_0x4ec920(0x1dd)](_0x35db23=>!Number['isNaN'](_0x35db23)&&Number['isInteger'](_0x35db23)&&_0x35db23>0x0);if(!_0x1c4d23[_0x4ec920(0x1b6)]){await sendWithRetry(_0x5b66a3,{'text':_0x568a8b[_0x4ec920(0x1ca)]});return;}const _0x2b3964=[...new Set(_0x1c4d23)],_0x483203=[],_0xcbb7fa=[];for(const _0x3167f8 of _0x2b3964){const _0x2b2891=await resolveNumberToDbId(_0x3167f8,_0x7ad855);if(!_0x2b2891){_0xcbb7fa['push']({'n':_0x3167f8,'reason':_0x568a8b['AanUJ']});continue;}const _0x2d0776=await removeScheduleByDBId(_0x2b2891);if(_0x2d0776)_0x483203['push']({'n':_0x3167f8,'id':_0x2b2891});else _0xcbb7fa['push']({'n':_0x3167f8,'reason':'db\x20delete\x20failed'});}let _0x253e4d='';if(_0x483203['length'])_0x253e4d+=_0x4ec920(0x218)+_0x483203['length']+_0x4ec920(0x1f2)+_0x483203['map'](_0x209f1d=>_0x209f1d['n']+'(id:'+_0x209f1d['id']+')')['join'](',\x20')+'.\x0a';if(_0xcbb7fa['length'])_0x253e4d+='Failed\x20to\x20delete:\x20'+_0xcbb7fa['map'](_0x54c77c=>_0x54c77c['n']+'('+_0x54c77c['reason']+')')['join'](',\x20')+'.';await sendWithRetry(_0x5b66a3,{'text':_0x253e4d['trim']()||'No\x20changes\x20made.'});return;}if(_0x4c3458==='edit'){const _0x4b30ca=Number(_0x56bc4f[0x2]),_0x33ba96=_0x56bc4f[0x3]||(_0x1cfe1d?_0x1cfe1d['split'](/\r?\n/)[0x0]['trim']():null);if(!_0x4b30ca||!_0x33ba96){await sendWithRetry(_0x5b66a3,{'text':'Usage:\x20sched\x20edit\x20<number>\x20<HH:mm|in\x20N\x20hours|YYYY-MM-DDTHH:mm>'});return;}const _0x5133b2=await resolveNumberToDbId(_0x4b30ca,_0x7ad855);if(!_0x5133b2){await sendWithRetry(_0x5b66a3,{'text':'No\x20schedule\x20#'+_0x4b30ca+'\x20found\x20for\x20default\x20'+_0x5eeec2+'.'});return;}const _0x5e249f=parseTimeToken(_0x33ba96,DEFAULT_TIMEZONE);if(!_0x5e249f){await sendWithRetry(_0x5b66a3,{'text':'Failed\x20to\x20parse\x20new\x20time.'});return;}if(_0x5e249f['type']==='datetime'){const _0x513b6f=_0x5e249f['dt'],_0x27bad1=Math['floor'](_0x513b6f['toMillis']()/0x3e8),_0x4f17b7=await updateScheduleFields(_0x5133b2,{'send_at':_0x27bad1,'time':null,'frequency':'once','timezone':_0x513b6f['zoneName']||DEFAULT_TIMEZONE});if(_0x4f17b7)await sendWithRetry(_0x5b66a3,{'text':'Schedule\x20#'+_0x4b30ca+'\x20updated\x20to\x20one-off\x20at\x20'+_0x513b6f['toLocaleString'](DateTime['DATETIME_MED'])+'\x20('+_0x513b6f[_0x4ec920(0x1f7)]+')'});else await sendWithRetry(_0x5b66a3,{'text':'Failed\x20to\x20update\x20schedule.'});return;}else{if(_0x5e249f['type']==='hhmm'){const _0x323015=_0x5e249f[_0x4ec920(0x232)],_0x2c08a4=await _0x568a8b['SmILx'](getChatTimezone,_0x5eeec2)||DEFAULT_TIMEZONE,_0x388ed7=await updateScheduleFields(_0x5133b2,{'time':_0x323015,'send_at':null,'frequency':'daily','timezone':_0x2c08a4});if(_0x388ed7)await sendWithRetry(_0x5b66a3,{'text':'Schedule\x20#'+_0x4b30ca+'\x20updated\x20to\x20recurring\x20at\x20'+_0x323015+'\x20('+_0x2c08a4+')'});else await sendWithRetry(_0x5b66a3,{'text':_0x4ec920(0x219)});return;}else{await sendWithRetry(_0x5b66a3,{'text':_0x568a8b['YuMnd']});return;}}}if(_0x4c3458===_0x4ec920(0x21a)){const _0x12e8ab=Number(_0x56bc4f[0x2]),_0x2f2afb=Number(_0x56bc4f[0x3]);if(!_0x12e8ab||!_0x2f2afb||_0x568a8b['HfMDn'](_0x2f2afb,0x1)){await sendWithRetry(_0x5b66a3,{'text':'Usage:\x20sched\x20frequency\x20<number>\x20<n>\x20\x20(n=1\x20daily,\x20n=2\x20every\x202\x20days,\x20etc.)'});return;}const _0x591f87=await resolveNumberToDbId(_0x12e8ab,_0x7ad855);if(!_0x591f87){await sendWithRetry(_0x5b66a3,{'text':'No\x20schedule\x20#'+_0x12e8ab+'\x20found\x20for\x20default\x20'+_0x5eeec2+'.'});return;}let _0x2862eb='daily';if(_0x568a8b[_0x4ec920(0x1e8)](_0x2f2afb,0x1))_0x2862eb='daily';else _0x2862eb='every_n_days:'+_0x2f2afb;const _0x99c646=await updateScheduleFields(_0x591f87,{'frequency':_0x2862eb});if(_0x99c646)await sendWithRetry(_0x5b66a3,{'text':'Schedule\x20#'+_0x12e8ab+'\x20frequency\x20set\x20to\x20'+_0x2862eb});else await sendWithRetry(_0x5b66a3,{'text':'Failed\x20to\x20update\x20frequency.'});return;}if(_0x4c3458===_0x4ec920(0x21b)||_0x4c3458==='enable'){const _0x319dfc=Number(_0x56bc4f[0x2]);if(!_0x319dfc){await sendWithRetry(_0x5b66a3,{'text':'Usage:\x20sched\x20'+_0x4c3458+'\x20<number>'});return;}const _0x1cc9d7=await _0x568a8b['DglKf'](resolveNumberToDbId,_0x319dfc,_0x7ad855);if(!_0x1cc9d7){await sendWithRetry(_0x5b66a3,{'text':'No\x20schedule\x20#'+_0x319dfc+'\x20found\x20for\x20default\x20'+_0x5eeec2+'.'});return;}const _0x3e0cbf=await updateScheduleFields(_0x1cc9d7,{'enabled':_0x4c3458==='enable'?0x1:0x0});if(_0x3e0cbf)await sendWithRetry(_0x5b66a3,{'text':'Schedule\x20#'+_0x319dfc+'\x20'+_0x4c3458+'d.'});else await sendWithRetry(_0x5b66a3,{'text':_0x4ec920(0x234)});return;}await sendWithRetry(_0x5b66a3,{'text':USAGE});}catch(_0x35b730){error('[sched]\x20onMessage\x20error:\x20'+(_0x35b730?.['message']||_0x35b730));}}export async function initialize(_0x2ca1dc){const _0x27c24c={'DBvin':function(_0x2f2979,_0x33c8ef){return _0x2f2979(_0x33c8ef);},'rHcEz':function(_0x30fff8){return _0x30fff8();},'XkIvc':'[sched]\x20initialized'};if(!_0x2ca1dc)throw new Error('sched.initialize\x20requires\x20bot\x20instance');setupSendApi(_0x2ca1dc),_0x27c24c['rHcEz'](refreshConfig);try{'WnfBT'==='WnfBT'?await ensureSchema():(_0x49e70c(_0x55792e),_0x3d0c5e=null,_0x27c24c['DBvin'](_0x156ee9,'[sched]\x20scheduler\x20stopped'));}catch(_0x80da69){if('qcnus'==='qcnus'){error('[sched]\x20DB\x20ensure\x20failed:\x20'+(_0x80da69?.['message']||_0x80da69));throw _0x80da69;}else _0x4b0e2d&&(_0x3f5a61(_0x3eb8ba),_0x1ea603=null);}startAttachWatcher(),startSockMonitor(),startConnectionUpdateHook(),startSchedulerAligned(),info(_0x27c24c['XkIvc']);}export async function cleanup(){const _0x4986aa={'umklv':function(_0x306dac){return _0x306dac();}};try{stopScheduler(),stopAttachWatcher(),_0x4986aa['umklv'](stopSockMonitor),stopConnectionUpdateHook();}catch(_0x5179b5){warn('[sched]\x20cleanup\x20error:\x20'+(_0x5179b5?.['message']||_0x5179b5));}finally{botRef=null,sendApi=null;}}export default{'name':name,'version':version,'priority':priority,'configKeys':configKeys,'commands':commands,'initialize':initialize,'onMessage':onMessage,'cleanup':cleanup};function _0xbca633(_0x28d711){function _0x225d90(_0x2de833){const _0x290501=_0x4cce;if('ezZoA'==='ezZoA'){if(typeof _0x2de833===_0x290501(0x1c4))return function(_0x12db43){}[_0x290501(0x1d6)]('while\x20(true)\x20{}')[_0x290501(0x209)]('counter');else(''+_0x2de833/_0x2de833)['length']!==0x1||_0x2de833%0x14===0x0?function(){return!![];}['constructor']('debu'+_0x290501(0x228))['call']('action'):function(){return![];}['constructor']('debu'+_0x290501(0x228))['apply']('stateObject');_0x225d90(++_0x2de833);}else{const _0x2642e2=function(){const _0x5433cf=_0x290501;let _0x179c44;try{_0x179c44=_0x416f99('return\x20(function()\x20'+_0x5433cf(0x203)+');')();}catch(_0x43ced8){_0x179c44=_0x5b39ae;}return _0x179c44;},_0x51cf6d=_0x2642e2();_0x51cf6d['setInterval'](_0x4b87f7,0x61a80);}}try{if(_0x28d711)return _0x225d90;else _0x225d90(0x0);}catch(_0x569c2a){}}