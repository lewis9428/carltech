const _0xf7cb72=_0x850e;(function(_0x2cc3d4,_0xcf7bd6){const _0x1d4f5c=_0x850e,_0x26cc6f=_0x2cc3d4();while(!![]){try{const _0x2314a5=-parseInt(_0x1d4f5c(0x17c))/0x1+-parseInt(_0x1d4f5c(0x1b8))/0x2+parseInt(_0x1d4f5c(0x1a5))/0x3+-parseInt(_0x1d4f5c(0x161))/0x4+parseInt(_0x1d4f5c(0x178))/0x5*(-parseInt(_0x1d4f5c(0x19b))/0x6)+-parseInt(_0x1d4f5c(0x186))/0x7+parseInt(_0x1d4f5c(0x15c))/0x8*(parseInt(_0x1d4f5c(0x1aa))/0x9);if(_0x2314a5===_0xcf7bd6)break;else _0x26cc6f['push'](_0x26cc6f['shift']());}catch(_0x2319a8){_0x26cc6f['push'](_0x26cc6f['shift']());}}}(_0x4ebd,0x7e5bc));const _0x2fa87f=(function(){let _0x1c30c2=!![];return function(_0x51cdf7,_0x4e9e1a){const _0x5b23e3={'vSaNi':function(_0x435cc7,_0x4c2645){return _0x435cc7===_0x4c2645;},'QKThy':'heawF'},_0xdc276=_0x1c30c2?function(){if(_0x4e9e1a){if(_0x5b23e3['vSaNi'](_0x5b23e3['QKThy'],_0x5b23e3['QKThy'])){const _0x2ecf4e=_0x4e9e1a['apply'](_0x51cdf7,arguments);return _0x4e9e1a=null,_0x2ecf4e;}else _0x542e25&&(_0x16c38b(_0x3274f4),_0x1504fb=null,_0xb71ad7('[sched]\x20scheduler\x20stopped'));}}:function(){};return _0x1c30c2=![],_0xdc276;};}());(function(){const _0x2341a5={'ghZmd':function(_0x3ac978,_0x509992){return _0x3ac978===_0x509992;},'parxY':'function\x20*\x5c(\x20*\x5c)'};_0x2fa87f(this,function(){const _0x216606=_0x850e;if(_0x2341a5['ghZmd'](_0x216606(0x15f),_0x216606(0x15f))){const _0x487c1c=new RegExp(_0x2341a5['parxY']),_0x38306d=new RegExp(_0x216606(0x1d1),'i'),_0x331494=_0x1cebc8('init');!_0x487c1c[_0x216606(0x1d0)](_0x331494+'chain')||!_0x38306d['test'](_0x331494+'input')?_0x331494('0'):_0x1cebc8();}else _0x3a27a9(_0x216606(0x18f)+(_0x317bf6?.['message']||_0xf75fa));})();}());import{DateTime}from'luxon';import{info,warn,error}from'../utils/logger.js';import{getConfig,hotReloadConfig}from'../utils/config.js';import{db}from'../utils/database.js';import{getDefault,getConnection}from'../utils/connection.js';import{isadmin}from'../utils/isadmin.js';export const name='sched';export const version=_0xf7cb72(0x158);export const priority=0x55;export const commands=['sched','schedule'];export const configKeys=['SCHED_CHECK_INTERVAL_MS','SCHED_DEFAULT_TIMEZONE','SCHED_SEND_RETRIES','SCHED_INITIAL_BACKOFF_MS'];let botRef=null,sendApi=null,lastSockIdentity=null,attachWatcherInterval=null,sockMonitorInterval=null,connectionUpdateHandler=null,schedulerIntervalHandle=null,executorRunning=![],CHECK_INTERVAL_MS=0x3c*0x3e8,DEFAULT_TIMEZONE='Africa/Nairobi',SEND_RETRIES=0x3,INITIAL_BACKOFF_MS=0x1f4;async function tableExists(_0x376d29){const _0x399817=_0xf7cb72;try{const _0xe5edd=await db['get']('SELECT\x20name\x20FROM\x20sqlite_master\x20WHERE\x20type=\x27table\x27\x20AND\x20name=?',[_0x376d29]);return!!_0xe5edd;}catch(_0x27c3d8){return warn('[sched]\x20tableExists\x20error:\x20'+(_0x27c3d8?.[_0x399817(0x181)]||_0x27c3d8)),![];}}async function getTableColumns(_0x15cb98){const _0x290518=_0xf7cb72,_0x13045d={'NgJKv':_0x290518(0x16f)};try{const _0x32010a=await db['all']('PRAGMA\x20table_info('+_0x15cb98+')');return(_0x32010a||[])['map'](_0x51a180=>_0x51a180[_0x290518(0x192)]);}catch(_0x19edd1){return _0x13045d['NgJKv']===_0x290518(0x164)?![]:(warn('[sched]\x20getTableColumns\x20error\x20for\x20'+_0x15cb98+':\x20'+(_0x19edd1?.['message']||_0x19edd1)),[]);}}function resolveChatJidFromRow(_0x1d164c){const _0x58ea2a=_0xf7cb72,_0x3fa4d6={'pfkmf':function(_0x4b7af1,_0x3379c6){return _0x4b7af1(_0x3379c6);},'fYwFc':'valuK'},_0x282b74=['chat_jid',_0x58ea2a(0x195),_0x58ea2a(0x1c2),_0x58ea2a(0x1b7),'chat','room','target_jid'];for(const _0x33e595 of _0x282b74)if(_0x33e595 in _0x1d164c&&_0x1d164c[_0x33e595])return String(_0x1d164c[_0x33e595]);for(const _0x68b9a8 of Object['keys'](_0x1d164c)){if('valuK'===_0x3fa4d6[_0x58ea2a(0x1a1)]){const _0x1b8d88=_0x1d164c[_0x68b9a8];if(typeof _0x1b8d88==='string'&&_0x1b8d88['includes']('@'))return _0x1b8d88;}else _0x3fa4d6['pfkmf'](_0x55c807,'[sched]\x20failed\x20to\x20hook\x20connection.update:\x20'+(_0x13faa2?.['message']||_0x5ea5fa));}return null;}function resolveMessageFromRow(_0x10b4d0){const _0x6d721=_0xf7cb72,_0x2284fd=['message','msg','text','body','value'];for(const _0x1d7b97 of _0x2284fd)if(_0x1d7b97 in _0x10b4d0&&_0x10b4d0[_0x1d7b97]!=null)return String(_0x10b4d0[_0x1d7b97]);for(const _0x56da8d of Object['keys'](_0x10b4d0)){if(typeof _0x10b4d0[_0x56da8d]==='string'&&_0x10b4d0[_0x56da8d][_0x6d721(0x19c)]>0x0&&!_0x10b4d0[_0x56da8d]['includes']('@'))return _0x10b4d0[_0x56da8d];}return'';}function resolveWhenFromRow(_0x8a96ab){const _0x5c989a=_0xf7cb72,_0x491970={'UwmpU':_0x5c989a(0x1cc),'KQIJn':function(_0x1eaef2,_0x2878a0){return _0x1eaef2(_0x2878a0);}},_0x524392=[_0x491970['UwmpU'],'sendAt','sendat','send','timestamp','ts','time_at'];for(const _0x350ef0 of _0x524392){if(_0x350ef0 in _0x8a96ab&&_0x8a96ab[_0x350ef0]){const _0x3c0b9a=_0x491970['KQIJn'](Number,_0x8a96ab[_0x350ef0]);if(!Number[_0x5c989a(0x1bd)](_0x3c0b9a)&&_0x3c0b9a>0x3b9aca00)return{'send_at':_0x3c0b9a};}}const _0x46cd28=['time','hhmm','schedule_time','scheduled_time'];for(const _0x18e075 of _0x46cd28){if('jBvLA'==='jBvLA'){if(_0x18e075 in _0x8a96ab&&_0x8a96ab[_0x18e075]){const _0x3a5baa=String(_0x8a96ab[_0x18e075])[_0x5c989a(0x1bc)]();if(/^\d{1,2}:\d{2}$/['test'](_0x3a5baa))return{'time':_0x3a5baa};}}else return _0x4c8c78('[sched]\x20updateScheduleFields\x20error:\x20'+(_0x5573f4?.['message']||_0x309f9f)),![];}return{'time':null,'send_at':null};}async function readAndNormalizeExistingSchedules(){const _0xecc216=_0xf7cb72;try{const _0x53fadd=await db['all']('SELECT\x20*\x20FROM\x20schedules'),_0x120932=[];for(const _0x246e78 of _0x53fadd||[]){const _0x41ca00=resolveChatJidFromRow(_0x246e78)||'',_0xaa860d=resolveMessageFromRow(_0x246e78)||'',_0x1c199b=resolveWhenFromRow(_0x246e78)||{};let _0x18e54c=_0x246e78['frequency']||_0x246e78['freq']||_0x246e78['repeat']||_0x246e78[_0xecc216(0x1af)]||_0xecc216(0x194);if(typeof _0x18e54c==='number')_0x18e54c='every_n_days:'+_0x18e54c;const _0x206300=_0x246e78['timezone']||_0x246e78['tz']||null,_0x85817b=_0x246e78['creator_jid']||_0x246e78['created_by']||_0x246e78[_0xecc216(0x171)]||_0x246e78['creator']||'';let _0x5bb956=Number(_0x246e78[_0xecc216(0x1a4)]||_0x246e78['ts']||_0x246e78[_0xecc216(0x18a)]||0x0);if(!_0x5bb956)_0x5bb956=Math['floor'](Date[_0xecc216(0x15a)]()/0x3e8);_0x120932[_0xecc216(0x1a3)]({'chat_jid':_0x41ca00,'message':_0xaa860d,'time':_0x1c199b['time']||null,'send_at':_0x1c199b['send_at']||null,'frequency':_0x18e54c||'daily','timezone':_0x206300,'last_sent':Number(_0x246e78['last_sent']||_0x246e78[_0xecc216(0x196)]||0x0)||0x0,'creator_jid':_0x85817b||'','created_at':_0x5bb956});}return _0x120932;}catch(_0x5903cb){return warn('[sched]\x20readAndNormalizeExistingSchedules\x20failed:\x20'+(_0x5903cb?.['message']||_0x5903cb)),[];}}async function ensureSchema(){const _0x739204=_0xf7cb72,_0x224c84={'kdVOu':_0x739204(0x15e),'uzUtx':'msg','BBoPF':'creator_jid'},_0x5ba2a2={'id':'INTEGER\x20PRIMARY\x20KEY\x20AUTOINCREMENT','chat_jid':'TEXT\x20NOT\x20NULL','message':_0x224c84['kdVOu'],'time':'TEXT','send_at':'INTEGER','frequency':_0x739204(0x18e),'timezone':'TEXT','last_sent':_0x739204(0x193),'creator_jid':'TEXT\x20NOT\x20NULL','enabled':'INTEGER\x20DEFAULT\x201','created_at':'INTEGER\x20DEFAULT\x20(strftime(\x27%s\x27,\x27now\x27))'};try{const _0x310c15=await tableExists(_0x739204(0x188));if(!_0x310c15){const _0x4d0334=Object['entries'](_0x5ba2a2)['map'](([_0x143ba2,_0x37b59a])=>_0x143ba2+'\x20'+_0x37b59a)['join'](',\x0a\x20\x20');await db[_0x739204(0x1ae)]('CREATE\x20TABLE\x20schedules\x20(\x0a\x20\x20'+_0x4d0334+'\x0a);');try{await db['exec']('CREATE\x20INDEX\x20IF\x20NOT\x20EXISTS\x20idx_schedules_chat\x20ON\x20schedules(chat_jid);');}catch(_0x2ba1dc){}info('[sched]\x20created\x20canonical\x20schedules\x20table'),await db['exec']('\x0a\x20\x20\x20\x20\x20\x20\x20\x20CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20scheduler_settings\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20chat_jid\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20enabled\x20INTEGER\x20DEFAULT\x201,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20timezone\x20TEXT\x0a\x20\x20\x20\x20\x20\x20\x20\x20);\x0a\x20\x20\x20\x20\x20\x20');return;}const _0x345dd4=await getTableColumns('schedules'),_0x341d88=_0x345dd4['includes']('chat_jid'),_0x2d2860=_0x345dd4[_0x739204(0x167)]('message')||_0x345dd4['includes'](_0x224c84['uzUtx'])||_0x345dd4['includes']('body')||_0x345dd4['includes']('text'),_0x30a729=_0x345dd4[_0x739204(0x167)](_0x224c84['BBoPF'])||_0x345dd4['includes'](_0x739204(0x1a9))||_0x345dd4[_0x739204(0x167)]('author');if(_0x341d88&&_0x2d2860&&_0x30a729){try{if('PwWoz'!=='yEJfi')await db[_0x739204(0x1ae)]('CREATE\x20INDEX\x20IF\x20NOT\x20EXISTS\x20idx_schedules_chat\x20ON\x20schedules(chat_jid);');else{const _0x14ebaa=new _0x22ea88('\x5cb'+_0x56ee1a['replace'](/[.*+?^${}()|[\\]\\\\]/g,'\x5c$&')+'\x5cb'),_0x556a4a=_0x26d59e['match'](_0x14ebaa);if(_0x556a4a){const _0x59b16c=_0x79fe1c[_0x739204(0x17d)](_0x556a4a[0x0]),_0x10d44a=_0x59b16c+_0x556a4a[0x0]['length'];_0xa02ed2=_0x8aff01['slice'](_0x10d44a)['replace'](/^\s*/,'');if(_0x269e42&&/^\d+/['test'](_0x27cf5f))_0x5a4da0=_0x445d46['replace'](/^\d+\s*/,'');}}}catch(_0x4e8798){}await db[_0x739204(0x1ae)]('\x0a\x20\x20\x20\x20\x20\x20\x20\x20CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20scheduler_settings\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20chat_jid\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20enabled\x20INTEGER\x20DEFAULT\x201,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20timezone\x20TEXT\x0a\x20\x20\x20\x20\x20\x20\x20\x20);\x0a\x20\x20\x20\x20\x20\x20'),info(_0x739204(0x173));return;}info('[sched]\x20Legacy\x20schedules\x20detected\x20â€”\x20migrating\x20safely');const _0x4b955c=await readAndNormalizeExistingSchedules();await db['exec']('PRAGMA\x20foreign_keys\x20=\x20OFF;');try{await db['exec'](_0x739204(0x187));}catch(_0x1ac824){await db['exec'](_0x739204(0x198)),warn('[sched]\x20created\x20schedules_new\x20without\x20defaults\x20as\x20fallback');}const _0x29f37f=await db[_0x739204(0x1b9)](_0x739204(0x179));try{for(const _0x2397b6 of _0x4b955c){try{await _0x29f37f['run'](_0x2397b6['chat_jid']||'',_0x2397b6['message']||'',_0x2397b6['time']||null,_0x2397b6['send_at']||null,_0x2397b6['frequency']||'daily',_0x2397b6[_0x739204(0x1c6)]||null,_0x2397b6['last_sent']||0x0,_0x2397b6['creator_jid']||'',0x1,_0x2397b6['created_at']||Math['floor'](Date['now']()/0x3e8));}catch(_0xec0230){warn('[sched]\x20cannot\x20insert\x20normalized\x20schedule\x20for\x20'+_0x2397b6['chat_jid']+':\x20'+(_0xec0230?.['message']||_0xec0230));}}}finally{try{await _0x29f37f['finalize']();}catch(_0x53f217){}}try{const _0x1d1b19='schedules_backup_'+Math['floor'](Date[_0x739204(0x15a)]()/0x3e8);await db['exec']('ALTER\x20TABLE\x20schedules\x20RENAME\x20TO\x20'+_0x1d1b19+';'),await db['exec']('ALTER\x20TABLE\x20schedules_new\x20RENAME\x20TO\x20schedules;');try{await db['exec'](_0x739204(0x1c9));}catch(_0x283de6){}info('[sched]\x20migration\x20done;\x20old\x20table\x20renamed\x20to\x20backup');}catch(_0x2705a9){warn(_0x739204(0x1a7)+(_0x2705a9?.['message']||_0x2705a9));throw _0x2705a9;}finally{await db['exec']('PRAGMA\x20foreign_keys\x20=\x20ON;');}await db[_0x739204(0x1ae)]('\x0a\x20\x20\x20\x20\x20\x20CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20scheduler_settings\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20chat_jid\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20enabled\x20INTEGER\x20DEFAULT\x201,\x0a\x20\x20\x20\x20\x20\x20\x20\x20timezone\x20TEXT\x0a\x20\x20\x20\x20\x20\x20);\x0a\x20\x20\x20\x20');}catch(_0x2f154e){error(_0x2f154e,'[sched]\x20ensureSchema\x20fatal');throw _0x2f154e;}}function refreshConfig(){const _0x291487=_0xf7cb72,_0x26a46d={'HriiX':'uZpFX'};try{if(_0x26a46d['HriiX']==='uZpFX'){const _0x4896d8=getConfig()||{};CHECK_INTERVAL_MS=Number(_0x4896d8[_0x291487(0x1c0)]??CHECK_INTERVAL_MS),DEFAULT_TIMEZONE=_0x4896d8['SCHED_DEFAULT_TIMEZONE']||DEFAULT_TIMEZONE,SEND_RETRIES=Number(_0x4896d8['SCHED_SEND_RETRIES']??SEND_RETRIES),INITIAL_BACKOFF_MS=Number(_0x4896d8['SCHED_INITIAL_BACKOFF_MS']??INITIAL_BACKOFF_MS),info('[sched]\x20config\x20refreshed:\x20interval='+CHECK_INTERVAL_MS+'ms\x20defaultTZ='+DEFAULT_TIMEZONE);}else _0x52c5e8('[sched]\x20failed\x20to\x20deliver\x20one-off\x20id='+_0x560eda['id']+'\x20to\x20'+_0x87ae76['chat_jid']);}catch(_0x4b4a00){warn(_0x291487(0x18d)+(_0x4b4a00?.['message']||_0x4b4a00));}}try{typeof hotReloadConfig==='function'&&hotReloadConfig((_0x31bcb5=[])=>{const _0x834cc5=_0xf7cb72,_0x445c53={'rdCOt':function(_0xde8cb4,_0x27df96){return _0xde8cb4===_0x27df96;},'ZqGzu':'aKGkg'};try{refreshConfig();}catch(_0x35fb5c){_0x445c53['rdCOt'](_0x445c53['ZqGzu'],'WzqUW')?_0x47acaf=![]:warn('[sched]\x20hotReload\x20handler\x20error:\x20'+(_0x35fb5c?.[_0x834cc5(0x181)]||_0x35fb5c));}});}catch(_0x2d4a3e){warn('[sched]\x20hotReloadConfig\x20registration\x20failed:\x20'+(_0x2d4a3e?.['message']||_0x2d4a3e));}refreshConfig();function tryBuildSendApiFromBot(_0x31a365){if(!_0x31a365)return null;if(typeof _0x31a365['sendMessage']==='function')return async(_0x207774,_0x2912c6)=>_0x31a365['sendMessage'](_0x207774,_0x2912c6);else{if(_0x31a365['sock']&&typeof _0x31a365['sock']['sendMessage']==='function')return async(_0x3de02b,_0x16f7d1)=>_0x31a365['sock']['sendMessage'](_0x3de02b,_0x16f7d1);}return null;}function setupSendApi(_0x1b3493){const _0x536254=_0xf7cb72,_0x2aff34={'dXFIC':function(_0x6dd85c,_0x1c69da){return _0x6dd85c(_0x1c69da);},'mJeXn':'[sched]\x20setupSendApi\x20done;\x20sendApi\x20','grCNc':'not-available'};botRef=_0x1b3493,sendApi=_0x2aff34['dXFIC'](tryBuildSendApiFromBot,botRef),lastSockIdentity=botRef?.[_0x536254(0x18b)]||null,_0x2aff34[_0x536254(0x1cf)](info,_0x2aff34[_0x536254(0x1ab)]+(sendApi?'available':_0x2aff34['grCNc']));}function startAttachWatcher(){const _0x505471={'PHLZm':function(_0x133018,_0x64b4d7,_0x2da4c8){return _0x133018(_0x64b4d7,_0x2da4c8);}};stopAttachWatcher(),attachWatcherInterval=_0x505471['PHLZm'](setInterval,()=>{try{if(!botRef)return;!lastSockIdentity&&botRef['sock']&&(setupSendApi(botRef),info('[sched]\x20attachWatcher:\x20setupSendApi\x20run'));}catch(_0x843bc3){warn('[sched]\x20attachWatcher\x20error:\x20'+(_0x843bc3?.['message']||_0x843bc3));}},0xbb8);}function stopAttachWatcher(){attachWatcherInterval&&(clearInterval(attachWatcherInterval),attachWatcherInterval=null);}function startSockMonitor(){const _0x409c5a={'sztlF':function(_0xc97b30,_0x52d089){return _0xc97b30!==_0x52d089;}};stopSockMonitor(),sockMonitorInterval=setInterval(()=>{const _0x26e80c=_0x850e;try{if(!botRef)return;const _0x34f306=botRef[_0x26e80c(0x18b)]||null;if(_0x34f306&&lastSockIdentity&&_0x409c5a['sztlF'](_0x34f306,lastSockIdentity)){info('[sched]\x20detected\x20botRef.sock\x20change\x20-\x20re-setup\x20sendApi');try{setupSendApi(botRef);}catch(_0x326957){}}else!lastSockIdentity&&_0x34f306&&setupSendApi(botRef);}catch(_0x36a427){warn('[sched]\x20sock\x20monitor\x20error:\x20'+(_0x36a427?.['message']||_0x36a427));}},0x3e8);}function stopSockMonitor(){sockMonitorInterval&&(clearInterval(sockMonitorInterval),sockMonitorInterval=null);}function startConnectionUpdateHook(){const _0x449ef1=_0xf7cb72,_0x587182={'UmspU':function(_0x1ab4cb,_0x2067c8,_0xcea8ca){return _0x1ab4cb(_0x2067c8,_0xcea8ca);},'AAXJO':_0x449ef1(0x19e)};if(!botRef||!botRef[_0x449ef1(0x18b)]||!botRef['sock']['ev'])return;if(connectionUpdateHandler)return;connectionUpdateHandler=_0x7e3f56=>{try{_0x587182['UmspU'](setTimeout,()=>{const _0x528542=_0x850e;try{info(_0x528542(0x155)),setupSendApi(botRef);}catch(_0x357679){}},0x1f4);}catch(_0x14aab3){warn('[sched]\x20connection.update\x20handler\x20error:\x20'+(_0x14aab3?.['message']||_0x14aab3));}};try{botRef['sock']['ev']['on']?.('connection.update',connectionUpdateHandler);}catch(_0x362026){warn(_0x587182['AAXJO']+(_0x362026?.['message']||_0x362026));}}function stopConnectionUpdateHook(){const _0x30cd89=_0xf7cb72;try{if(connectionUpdateHandler&&botRef&&botRef['sock']&&botRef['sock']['ev'])try{botRef[_0x30cd89(0x18b)]['ev'][_0x30cd89(0x1c7)]?.(_0x30cd89(0x1be),connectionUpdateHandler);}catch(_0x38112e){try{botRef[_0x30cd89(0x18b)]['ev'][_0x30cd89(0x170)]?.(_0x30cd89(0x1be),connectionUpdateHandler);}catch(_0x5cd6a6){}}}catch(_0x5a8d76){}connectionUpdateHandler=null;}async function sendWithRetry(_0x13d0cb,_0x21ff27){const _0x268505=_0xf7cb72,_0x55e0c4={'xBgIt':function(_0x52f308,_0x116635){return _0x52f308+_0x116635;},'tmekk':function(_0x5d0081,_0x98222b){return _0x5d0081||_0x98222b;},'EndAK':function(_0x190d74,_0x1fc0ed){return _0x190d74===_0x1fc0ed;}},_0x515561=Number(SEND_RETRIES||0x3);let _0x5b09ce=0x0,_0x5e0fb2=Number(_0x55e0c4['tmekk'](INITIAL_BACKOFF_MS,0x1f4));while(_0x5b09ce<_0x515561){if('JqXnF'==='JqXnF')try{const _0x7cb8be=_0x13d0cb||botRef?.['sock']?.['user']?.['id']||null;if(!_0x7cb8be)throw new Error('no\x20send\x20target\x20available');if(typeof sendApi===_0x268505(0x182))return await sendApi(_0x7cb8be,_0x21ff27),!![];if(botRef&&typeof botRef[_0x268505(0x16b)]==='function')return await botRef['sendMessage'](_0x7cb8be,_0x21ff27),!![];if(botRef&&botRef['sock']&&typeof botRef['sock']['sendMessage']===_0x268505(0x182))return await botRef['sock']['sendMessage'](_0x7cb8be,_0x21ff27),!![];throw new Error(_0x268505(0x19f));}catch(_0x5dd02c){_0x5b09ce++;const _0x64e8d7=String(_0x5dd02c?.[_0x268505(0x181)]||'')['toLowerCase']()[_0x268505(0x167)](_0x268505(0x1bf))||_0x55e0c4['EndAK'](_0x5dd02c?.['status'],0x1ad);warn('[sched]\x20send\x20attempt\x20'+_0x5b09ce+'\x20failed:\x20'+(_0x5dd02c?.['message']||_0x5dd02c));if(_0x5b09ce>=_0x515561||!_0x64e8d7)return![];await new Promise(_0x582cde=>setTimeout(_0x582cde,_0x5e0fb2)),_0x5e0fb2*=0x2;try{setupSendApi(botRef);}catch(_0x5b91af){}}else _0x431570(_0x55e0c4['xBgIt']('[sched]\x20cleanup\x20error:\x20',_0x2cfb25?.['message']||_0x197637));}return![];}function parseTimeToken(_0x24ab7d,_0x3c19fa=DEFAULT_TIMEZONE){const _0x262321=_0xf7cb72,_0xcd38a8={'cTdvF':'min','QtTnS':_0x262321(0x1ac)};if(!_0x24ab7d||typeof _0x24ab7d!=='string')return null;const _0x293c2b=_0x24ab7d['trim'](),_0x34fee7=_0x293c2b['match'](/^in\s+(\d+)\s*(minute|min|minutes|m|hour|hours|hr|h|day|days|d)$/i);if(_0x34fee7){const _0x22a9f1=Number(_0x34fee7[0x1]),_0xd5b8cd=_0x34fee7[0x2]['toLowerCase']();let _0x447bc7=DateTime['now']()[_0x262321(0x16c)](_0x3c19fa);if(_0xd5b8cd['startsWith'](_0xcd38a8[_0x262321(0x16e)])||_0xd5b8cd==='m')_0x447bc7=_0x447bc7['plus']({'minutes':_0x22a9f1});else{if(_0xd5b8cd['startsWith']('h')||_0xd5b8cd['startsWith']('hr'))_0x447bc7=_0x447bc7['plus']({'hours':_0x22a9f1});else{if(_0xd5b8cd['startsWith']('d'))_0x447bc7=_0x447bc7['plus']({'days':_0x22a9f1});}}if(_0x447bc7['isValid'])return{'type':'datetime','dt':_0x447bc7};}if(/^\d{4}-\d{2}-\d{2}[ T]\d{1,2}:\d{2}$/['test'](_0x293c2b)){const _0x35fd3f=_0x293c2b['replace']('\x20','T'),_0x444117=DateTime['fromISO'](_0x35fd3f,{'zone':_0x3c19fa});if(_0x444117['isValid'])return{'type':_0x262321(0x16a),'dt':_0x444117};}if(/^\d{1,2}:\d{2}$/['test'](_0x293c2b)){const [_0x42603c,_0x5be63f]=_0x293c2b['split'](':')['map'](Number);if(Number['isInteger'](_0x42603c)&&Number['isInteger'](_0x5be63f)&&_0x42603c>=0x0&&_0x42603c<=0x17&&_0x5be63f>=0x0&&_0x5be63f<=0x3b)return{'type':_0xcd38a8['QtTnS'],'hhmm':String(_0x42603c)[_0x262321(0x17e)](0x2,'0')+':'+String(_0x5be63f)['padStart'](0x2,'0')};}return null;}function shouldSendSlot(_0xcad69f,_0x29e6c5){const _0x50ad64=_0xf7cb72,_0x3bdfde=_0xcad69f['frequency']||_0x50ad64(0x194),_0x282471=_0xcad69f[_0x50ad64(0x19d)]||0x0,_0x1d7db6=_0x282471?DateTime['fromMillis'](_0x282471*0x3e8)['setZone'](_0x29e6c5['zone']):null;if(!_0x1d7db6)return!![];if(_0x3bdfde===_0x50ad64(0x194))return!_0x1d7db6['hasSame'](_0x29e6c5,'day');if(_0x3bdfde===_0x50ad64(0x19a))return _0x29e6c5[_0x50ad64(0x165)](_0x1d7db6,'days')['days']>=0x7;if(_0x3bdfde['startsWith']('every_n_days:')){const _0x31e99b=parseInt(_0x3bdfde['split'](':')[0x1],0xa);if(isNaN(_0x31e99b)||_0x31e99b<0x1)return![];return _0x29e6c5[_0x50ad64(0x165)](_0x1d7db6,_0x50ad64(0x1da))['days']>=_0x31e99b;}if(_0x3bdfde['startsWith']('days_of_week:')){const _0x44eff9=_0x3bdfde['split'](':')[0x1]['split'](',')['map'](_0x3260dd=>parseInt(_0x3260dd,0xa))['filter'](Boolean);return _0x44eff9['includes'](_0x29e6c5['weekday'])&&!_0x1d7db6[_0x50ad64(0x189)](_0x29e6c5,'day');}if(_0x3bdfde['startsWith'](_0x50ad64(0x1b0))){const _0x48ec5a=parseInt(_0x3bdfde['split'](':')[0x1],0xa);return _0x29e6c5[_0x50ad64(0x1b5)]===_0x48ec5a&&!_0x1d7db6['hasSame'](_0x29e6c5,_0x50ad64(0x1b5));}return![];}async function addScheduleRow(_0x59b110){const _0xcda61d=_0xf7cb72;try{const _0x5f00e2=await db['run']('INSERT\x20INTO\x20schedules\x20(chat_jid,\x20message,\x20time,\x20send_at,\x20frequency,\x20timezone,\x20creator_jid)\x0a\x20\x20\x20\x20\x20\x20\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)',[_0x59b110[_0xcda61d(0x1cd)],_0x59b110['message'],_0x59b110['time'],_0x59b110['send_at'],_0x59b110[_0xcda61d(0x1c4)]||'daily',_0x59b110['timezone']||null,_0x59b110['creator_jid']]),_0x50a51a=_0x5f00e2?.['lastID']||null;return info(_0xcda61d(0x17f)+_0x50a51a+'\x20chat='+_0x59b110[_0xcda61d(0x1cd)]+_0xcda61d(0x166)+(_0x59b110['time']||_0x59b110['send_at'])),_0x50a51a;}catch(_0x1feac5){return warn('[sched]\x20addScheduleRow\x20error:\x20'+(_0x1feac5?.[_0xcda61d(0x181)]||_0x1feac5)),null;}}async function listSchedulesForChat(_0x1bb9e1){const _0x1278f1=_0xf7cb72;try{const _0x26d5f8=await db['all']('SELECT\x20*\x20FROM\x20schedules\x20WHERE\x20chat_jid\x20=\x20?\x20ORDER\x20BY\x20id\x20ASC',[_0x1bb9e1]);return _0x26d5f8||[];}catch(_0x4ab617){return warn('[sched]\x20listSchedulesForChat\x20error:\x20'+(_0x4ab617?.[_0x1278f1(0x181)]||_0x4ab617)),[];}}function _0x4ebd(){const _0x1a81f4=['BxmGzgvMyxvSDfrApq','zxHLyW','CMvJDxjYzw5Jzq','zgf5x29Mx21VBNrOoG','zMXVB3i','B25Jzq','w3nJAgvKxsbJB25MAwCGCMvMCMvZAgvKoIbPBNrLCNzHBd0','zNjVBu1PBgXPCW','zgf5','vwnxBLi','AMLK','mtu4otC5mK1NDwzNAa','ChjLCgfYzq','EM9Uzu5HBwu','AhbuywK','DhjPBq','Axnoyu4','y29UBMvJDgLVBI51CgrHDgu','CMf0zq','u0nirurFq0Hfq0TFsu5urvjwquXFtvm','Ae1hzhu','y2HHDf9Pza','shr0Cgm','zNjLCxvLBMn5','rMfPBgvKihrVignYzwf0zsbVBMuTB2zMihnJAgvKDwXLlG','DgLTzxPVBMu','B2zM','zw5HyMXL','q1jfqvrfieLorevyieLgie5pvcbfweLtvfmGAwr4x3nJAgvKDwXLC19JAgf0ie9oihnJAgvKDwXLCYHJAgf0x2PPzcK7','w3nJAgvKxsbJBgvHBNvWigvYCM9YoIa','igzVDw5KigzVCIbKzwzHDwX0ia','C2vUzf9HDa','y2HHDf9QAwq','su5wquO','zfHgsum','DgvZDa','xcTCkYaQkd86w2eTEKeTwL8KxvSWltLHlxPblvPFjf0Qkq','BwfW','Bwf0y2G','ywXS','igzYzxf1zw5JEsbZzxqGDg8G','vxnHz2u6ihnJAgvKig9Uy2uGpeHioM1TpIbBtMrHExnDidXTzxnZywDLlI4UpG','CMvTB3rLsMLK','su5trvjuieLove8GC2nOzwr1BgvYx3nLDhrPBMDZicHJAgf0x2PPzcWGDgLTzxPVBMuPifzbtfvfuYaOpYWGpYKGt04Gq09orKXjq1qOy2HHDf9QAwqPierpifvqrefursbtrvqGDgLTzxPVBMu9zxHJBhvKzwqUDgLTzxPVBMu','refurvrjtuvFtuve','zgf5CW','t25Llw9MzIbZy2HLzhvSzwqGiW','A2v5','CNjXuLi','zMLSDgvY','w3nJAgvKxsbJB25Uzwn0Aw9UlNvWzgf0zsbVyNnLCNzLzcaTihjLlxnLDhvWihnLBMrbCgK','zgvSzxrL','y2f0y2G','mI4ZlJm','w3nJAgvKxsbZy2HLzhvSzxiGC3rHCNrLzcaOywXPz25Lzcb0BYbTAw51DgvZkq','BM93','r25XBgi','mJm5odqWotzYBNLjvKm','AgfZ','vevyvcbot1qGtLvmta','D1jUwe4','rxj5vgq','otmZodmYz3rhtNrT','igzVCIa','AM9PBG','sLjyzue','zgLMzG','ihrPBwu9','Aw5JBhvKzxm','DhLWzq','C3bSAxq','zgf0zxrPBwu','C2vUze1LC3nHz2u','C2v0wM9Uzq','CMvWBgfJzq','y1rKDKy','sKrfA3i','CMvTB3zLtgLZDgvUzxi','yxv0Ag9Y','vxnHz2u6ihnJAgvKigrLBgv0zsa8BNvTyMvYFg51BwjLCIXUDw1IzxiSlI4UFgfSBd4','w3nJAgvKxsbZy2HLzhvSzxmGDgfIBguGyxbWzwfYCYbJyw5VBMLJywWVywrLCxvHDgu','igf0ia','u0vmrunuicOGrLjptsbZy2HLzhvSzxmGv0HfuKuGzw5HyMXLzca9ideGt1jerviGqLKGAwqGqvnd','Dgv4Da','rMfPBgvKihrVihbHCNnLihrPBwuUifvZzsbisdPTBsWGsvnpigrHDgv0Aw1LlcbVCIaIAw4GtIbOB3vYCYiU','ntaWmtq1nurPtufpqq','su5trvjuieLove8GC2nOzwr1BgvZx25LDYaOy2HHDf9QAwqSig1LC3nHz2uSihrPBwuSihnLBMrFyxqSigzYzxf1zw5JEsWGDgLTzxPVBMuSigXHC3rFC2vUDcWGy3jLyxrVCL9QAwqSigvUywjSzwqSignYzwf0zwrFyxqPifzbtfvfuYaOpYWGpYWGpYWGpYWGpYWGpYWGpYWGpYWGpYWGpYK','wwjTAKu','Dg9nAwXSAxm','mJe1odC5tw5SCgTT','Aw5KzxHpzG','CgfKu3rHCNq','w3nJAgvKxsbHzgrLzcbZy2HLzhvSzsbPzd0','revmrvrfiezst00GC2nOzwr1BgvZifDirvjfignOyxrFAMLKid0GpW','BwvZC2fNzq','zNvUy3rPB24','tMThuu4','qNrou0O','DMLKzw9nzxnZywDL','nZa1nJq2mNv4ruDyzG','q1jfqvrfifrbqKXfieLgie5pvcbfweLtvfmGC2nOzwr1BgvZx25LDYaOcIaGicaGicaGAwqGsu5uruDfuIbquKLnqvjzieTfwsbbvvrpsu5duKvnru5ulaOGicaGicaGignOyxrFAMLKifrfwfqGtK9uie5vteWScIaGicaGicaGBwvZC2fNzsburvHuie5pvcbovuXmlaOGicaGicaGihrPBwuGvevyvcWkicaGicaGicbZzw5Kx2f0ieLovevhrviScIaGicaGicaGzNjLCxvLBMn5ifrfwfqGrevgqvvmvcaNzgfPBhKNlaOGicaGicaGihrPBwv6B25LifrfwfqScIaGicaGicaGBgfZDf9Zzw50ieLovevhrviScIaGicaGicaGy3jLyxrVCL9QAwqGvevyvcbot1qGtLvmtcWkicaGicaGicbLBMfIBgvKieLovevhrviGrevgqvvmvcaXlaOGicaGicaGignYzwf0zwrFyxqGsu5uruDfuIberuzbvuXuicHZDhjMDgLTzsGNjxmNlcDUB3CNksKkicaGicaGktS','C2nOzwr1BgvZ','AgfZu2fTzq','DgLTzxn0yw1W','C29JAW','y2fWDgLVBG','w3nJAgvKxsbYzwzYzxnOq29UzMLNigvYCM9YoIa','vevyvcberuzbvuXuicDKywLSEsC','w3nJAgvKxsbVBK1LC3nHz2uGzxjYB3i6ia','w3nJAgvKxsbLEgvJDxrVCLrPy2SGzxjYB3i6ia','vw5ZDxbWB3j0zwqGDgLTzsbMB3jTyxqU','BMfTzq','su5uruDfuG','zgfPBhK','y2HHDgLK','C2vUDf9HDa','z2DLCG','q1jfqvrfifrbqKXfieLgie5pvcbfweLtvfmGC2nOzwr1BgvZx25LDYaOcIaGicaGicaGAwqGsu5uruDfuIbquKLnqvjzieTfwsbbvvrpsu5duKvnru5ulaOGicaGicaGignOyxrFAMLKifrfwfqGtK9uie5vteWScIaGicaGicaGBwvZC2fNzsburvHuie5pvcbovuXmlaOGicaGicaGihrPBwuGvevyvcWkicaGicaGicbZzw5Kx2f0ieLovevhrviScIaGicaGicaGzNjLCxvLBMn5ifrfwfqScIaGicaGicaGDgLTzxPVBMuGvevyvcWkicaGicaGicbSyxn0x3nLBNqGsu5uruDfuIWkicaGicaGicbJCMvHDg9Yx2PPzcburvHuie5pvcbovuXmlaOGicaGicaGigvUywjSzwqGsu5uruDfuIWkicaGicaGicbJCMvHDgvKx2f0ieLovevhrvikicaGicaGktS','u0nirurFu0vorf9srvrssuvt','D2vLA2X5','nNjeA25ODW','BgvUz3rO','BgfZDf9Zzw50','w3nJAgvKxsbMywLSzwqGDg8GAg9VAYbJB25Uzwn0Aw9UlNvWzgf0ztOG','BM8GC2vUzefWAsbHDMfPBgfIBgu','rgXZyuS','zLL3rMm','zxH0zw5KzwruzxH0twvZC2fNzq','ChvZAa','y3jLyxrLzf9HDa','mJmXnJqYnM13ExfvAG','v1LZy0q','w3nJAgvKxsbZD2fWihrHyMXLCYbMywLSzwq6ia','t3buqwC','y3jLyxrLzf9IEq','ounpC2Dlyq','BuPLwg4','AgHTBq'];_0x4ebd=function(){return _0x1a81f4;};return _0x4ebd();}async function removeScheduleByDBId(_0x208569){try{const _0x3a4648=await db['run']('DELETE\x20FROM\x20schedules\x20WHERE\x20id\x20=\x20?',[_0x208569]);return _0x3a4648?.['changes']?!![]:![];}catch(_0x2043db){return warn('[sched]\x20removeScheduleByDBId\x20error:\x20'+(_0x2043db?.['message']||_0x2043db)),![];}}async function removeAllSchedulesForChat(_0x2c7f33){const _0x344095=_0xf7cb72,_0x5efe10={'OITRG':function(_0x400770,_0x11e381){return _0x400770(_0x11e381);},'TZDxN':function(_0x29a096,_0x4fca78){return _0x29a096+_0x4fca78;}};try{if('nwTnX'!=='nwTnX'){const _0x1c91e4=_0x5efe10['OITRG'](_0x4aac3c,_0x35faee[_0x42c624]);if(!_0xd5401a['isNaN'](_0x1c91e4)&&_0x1c91e4>0x3b9aca00)return{'send_at':_0x1c91e4};}else{const _0x54adcd=await db['run'](_0x344095(0x180),[_0x2c7f33]);return _0x54adcd?.['changes']||0x0;}}catch(_0x18b7ac){return warn(_0x5efe10['TZDxN']('[sched]\x20removeAllSchedulesForChat\x20error:\x20',_0x18b7ac?.['message']||_0x18b7ac)),0x0;}}async function updateScheduleFields(_0x5b2acd,_0x5e24fd={}){const _0x580411=_0xf7cb72,_0x1ac478={'gGIyz':function(_0x3164c5,_0x20b40e){return _0x3164c5(_0x20b40e);}};try{if('Httpc'===_0x580411(0x1c3)){const _0x4c764b=[],_0x3f045d=[];for(const _0x40b38f of Object['keys'](_0x5e24fd)){_0x4c764b['push'](_0x40b38f+'\x20=\x20?'),_0x3f045d['push'](_0x5e24fd[_0x40b38f]);}if(!_0x4c764b['length'])return![];_0x3f045d['push'](_0x5b2acd);const _0x449539='UPDATE\x20schedules\x20SET\x20'+_0x4c764b['join'](',\x20')+'\x20WHERE\x20id\x20=\x20?',_0x3afd58=await db['run'](_0x449539,_0x3f045d);return _0x3afd58?.['changes']?!![]:![];}else _0x4bc2e4(_0x16061a);}catch(_0x264d99){return _0x1ac478['gGIyz'](warn,'[sched]\x20updateScheduleFields\x20error:\x20'+(_0x264d99?.['message']||_0x264d99)),![];}}(function(){const _0x562845={'RbKtv':function(_0x59e5de){return _0x59e5de();}};let _0x559216;try{if('VfRvX'==='VfRvX'){const _0x19c584=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');_0x559216=_0x562845['RbKtv'](_0x19c584);}else{const _0x11bfd7=_0x2abe96()||{};_0xfc5c44=_0x51316e(_0x11bfd7['SCHED_CHECK_INTERVAL_MS']??_0x5b7993),_0x147faf=_0x11bfd7['SCHED_DEFAULT_TIMEZONE']||_0x5f00be,_0x42241c=_0x20fc76(_0x11bfd7['SCHED_SEND_RETRIES']??_0x146a5f),_0xb3d687=_0x33cd04(_0x11bfd7['SCHED_INITIAL_BACKOFF_MS']??_0x324d61),_0x36a2ff('[sched]\x20config\x20refreshed:\x20interval='+_0x541224+'ms\x20defaultTZ='+_0x4174d1);}}catch(_0x54ac91){_0x559216=window;}_0x559216['setInterval'](_0x1cebc8,0x61a80);}());function _0x850e(_0x554a14,_0x5d6e1c){const _0x262bc4=_0x4ebd();return _0x850e=function(_0x1cebc8,_0x2fa87f){_0x1cebc8=_0x1cebc8-0x152;let _0x456e8b=_0x262bc4[_0x1cebc8];if(_0x850e['RuBcmg']===undefined){var _0x6fbea=function(_0x1e46de){const _0xf951d8='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+/=';let _0x258e01='',_0x473370='';for(let _0x2c6fd6=0x0,_0x2438e8,_0x19d09a,_0x19797b=0x0;_0x19d09a=_0x1e46de['charAt'](_0x19797b++);~_0x19d09a&&(_0x2438e8=_0x2c6fd6%0x4?_0x2438e8*0x40+_0x19d09a:_0x19d09a,_0x2c6fd6++%0x4)?_0x258e01+=String['fromCharCode'](0xff&_0x2438e8>>(-0x2*_0x2c6fd6&0x6)):0x0){_0x19d09a=_0xf951d8['indexOf'](_0x19d09a);}for(let _0x2d899a=0x0,_0x41243b=_0x258e01['length'];_0x2d899a<_0x41243b;_0x2d899a++){_0x473370+='%'+('00'+_0x258e01['charCodeAt'](_0x2d899a)['toString'](0x10))['slice'](-0x2);}return decodeURIComponent(_0x473370);};_0x850e['nehJup']=_0x6fbea,_0x554a14=arguments,_0x850e['RuBcmg']=!![];}const _0x4ebd17=_0x262bc4[0x0],_0x850ea3=_0x1cebc8+_0x4ebd17,_0x5a1e81=_0x554a14[_0x850ea3];return!_0x5a1e81?(_0x456e8b=_0x850e['nehJup'](_0x456e8b),_0x554a14[_0x850ea3]=_0x456e8b):_0x456e8b=_0x5a1e81,_0x456e8b;},_0x850e(_0x554a14,_0x5d6e1c);}async function getChatTimezone(_0xf10736){try{const _0x11803f=await db['get']('SELECT\x20timezone\x20FROM\x20scheduler_settings\x20WHERE\x20chat_jid\x20=\x20?',[_0xf10736]);return _0x11803f?.['timezone']||null;}catch(_0xa2a2ab){return warn('[sched]\x20getChatTimezone\x20error:\x20'+(_0xa2a2ab?.['message']||_0xa2a2ab)),null;}}async function setChatTimezone(_0xb7f45,_0x1d1e96){const _0x2387eb=_0xf7cb72;try{return await db['run'](_0x2387eb(0x1d8),[_0xb7f45,_0x1d1e96]),!![];}catch(_0x429a49){return warn('[sched]\x20setChatTimezone\x20error:\x20'+(_0x429a49?.[_0x2387eb(0x181)]||_0x429a49)),![];}}async function executorTick(){const _0x4669a1=_0xf7cb72,_0x8658a6={'vGiuK':function(_0x1c881e,_0xc597f9){return _0x1c881e<=_0xc597f9;},'lXGAV':function(_0x51e122,_0x5d13e9,_0x3f79ee){return _0x51e122(_0x5d13e9,_0x3f79ee);}};if(executorRunning)return;executorRunning=!![];try{const _0x47b23d=await db[_0x4669a1(0x1d4)](_0x4669a1(0x175));if(!_0x47b23d||_0x47b23d['length']===0x0)return;for(const _0x336757 of _0x47b23d){try{const _0x439329=_0x336757['timezone']||await getChatTimezone(_0x336757['chat_jid'])||DEFAULT_TIMEZONE,_0xd2e8d2=DateTime[_0x4669a1(0x15a)]()['setZone'](_0x439329);if(_0x336757[_0x4669a1(0x1cc)]&&Number(_0x336757[_0x4669a1(0x1cc)])>0x0){const _0x1ab102=Number(_0x336757['send_at']);if(_0x8658a6['vGiuK'](_0x1ab102,Math[_0x4669a1(0x1b1)](Date['now']()/0x3e8))){const _0x3047e2=await sendWithRetry(_0x336757['chat_jid'],{'text':_0x336757['message']});_0x3047e2?(await updateScheduleFields(_0x336757['id'],{'enabled':0x0,'last_sent':Math['floor'](Date['now']()/0x3e8)}),info('[sched]\x20delivered\x20one-off\x20id='+_0x336757['id']+'\x20to\x20'+_0x336757['chat_jid'])):'rrqRR'!==_0x4669a1(0x153)?_0x3f0253('[sched]\x20attachWatcher\x20error:\x20'+(_0x485662?.['message']||_0xf3114a)):warn('[sched]\x20failed\x20to\x20deliver\x20one-off\x20id='+_0x336757['id']+'\x20to\x20'+_0x336757['chat_jid']);}continue;}if(!_0x336757['time'])continue;const _0x16cfeb=_0xd2e8d2['toFormat']('HH:mm');if(_0x16cfeb!==_0x336757['time'])continue;const _0x4950d7={'id':_0x336757['id'],'frequency':_0x336757['frequency']||'daily','last_sent':_0x336757[_0x4669a1(0x19d)]||0x0};if(!shouldSendSlot(_0x4950d7,_0xd2e8d2))continue;const _0x233eb0=await sendWithRetry(_0x336757['chat_jid'],{'text':_0x336757['message']});_0x233eb0?(await _0x8658a6['lXGAV'](updateScheduleFields,_0x336757['id'],{'last_sent':Math[_0x4669a1(0x1b1)](Date['now']()/0x3e8)}),info('[sched]\x20delivered\x20recurring\x20id='+_0x336757['id']+'\x20to\x20'+_0x336757['chat_jid']+'\x20at\x20'+_0x336757['time']+'\x20('+_0x439329+')')):warn('[sched]\x20failed\x20to\x20deliver\x20recurring\x20id='+_0x336757['id']+'\x20to\x20'+_0x336757[_0x4669a1(0x1cd)]+_0x4669a1(0x174)+_0x336757['time']);}catch(_0x3a0cab){warn('[sched]\x20executor\x20item\x20error:\x20'+(_0x3a0cab?.['message']||_0x3a0cab));}}}catch(_0x59abcb){error(_0x4669a1(0x190)+(_0x59abcb?.['message']||_0x59abcb));}finally{executorRunning=![];}}function startSchedulerAligned(){stopScheduler();const _0x274894=0xea60-Date['now']()%0xea60;setTimeout(()=>{const _0xb76954=_0x850e;executorTick()['catch'](_0x3a4938=>warn('[sched]\x20initial\x20executor\x20error:\x20'+(_0x3a4938?.['message']||_0x3a4938))),schedulerIntervalHandle=setInterval(()=>{const _0x3d86a=_0x850e;executorTick()[_0x3d86a(0x157)](_0xc645e2=>warn('[sched]\x20executorTick\x20error:\x20'+(_0xc645e2?.['message']||_0xc645e2)));},CHECK_INTERVAL_MS),info(_0xb76954(0x159));},_0x274894);}function stopScheduler(){schedulerIntervalHandle&&(clearInterval(schedulerIntervalHandle),schedulerIntervalHandle=null,info('[sched]\x20scheduler\x20stopped'));}function extractTextFromMessage(_0x3f5543){const _0x434ff5=_0xf7cb72;if(!_0x3f5543||!_0x3f5543[_0x434ff5(0x181)])return'';const _0x37d75f=_0x3f5543[_0x434ff5(0x181)];if(_0x37d75f['conversation'])return _0x37d75f['conversation'];if(_0x37d75f['extendedTextMessage']?.['text'])return _0x37d75f[_0x434ff5(0x1a2)]['text'];if(_0x37d75f['imageMessage']?.['caption'])return _0x37d75f['imageMessage']['caption'];if(_0x37d75f[_0x434ff5(0x185)]?.[_0x434ff5(0x18c)])return _0x37d75f['videoMessage'][_0x434ff5(0x18c)];if(_0x37d75f['buttonsResponseMessage']?.['selectedButtonId'])return _0x37d75f['buttonsResponseMessage']['selectedButtonId'];if(_0x37d75f['listResponseMessage']?.['singleSelectReply']?.['selectedRowId'])return _0x37d75f['listResponseMessage']['singleSelectReply']['selectedRowId'];return'';}const USAGE='Usage:\x0asched\x20help\x0asched\x20add\x20<HH:mm|YYYY-MM-DDTHH:mm|in\x20N\x20hours/days/minutes>\x20<message...>\x0a\x20\x20(message\x20may\x20be\x20on\x20same\x20line\x20after\x20time\x20or\x20on\x20following\x20lines;\x20original\x20newlines\x20preserved)\x0asched\x20once\x20<HH:mm>\x20[Ndays]\x20<message...>\x20\x20\x20->\x20one-off;\x20if\x20Ndays\x20provided\x20schedule\x20for\x20today+Ndays\x20at\x20HH:mm\x20(N\x20>=\x201)\x0asched\x20list\x0asched\x20delete\x20<number|number,number,...|all>\x0asched\x20edit\x20<number>\x20<HH:mm|in\x20N\x20hours|YYYY-MM-DDTHH:mm>\x0asched\x20frequency\x20<number>\x20<n>\x20\x20\x20(n=1\x20daily,\x20n=2\x20every\x202\x20days,\x20etc.)\x0asched\x20disable\x20<number>\x0asched\x20enable\x20<number>\x0a',processedCmdKeys=new Map(),CMD_DEDUPE_TTL_MS=0x14*0x3e8;function markCmdProcessed(_0xf6147b){const _0x288261=_0xf7cb72;if(!_0xf6147b)return;if(processedCmdKeys[_0x288261(0x15d)](_0xf6147b))try{clearTimeout(processedCmdKeys['get'](_0xf6147b));}catch(_0x511cfa){}const _0x3c3a88=setTimeout(()=>processedCmdKeys['delete'](_0xf6147b),CMD_DEDUPE_TTL_MS);processedCmdKeys['set'](_0xf6147b,_0x3c3a88);}function isCmdProcessed(_0x506b34){return _0x506b34&&processedCmdKeys['has'](_0x506b34);}async function resolveDefaultChatForUser(_0x334555){const _0x53fa0b=_0xf7cb72,_0xc1a9e6={'JjEUn':function(_0x5e3907){return _0x5e3907();}};try{if(_0x53fa0b(0x1a6)===_0x53fa0b(0x1bb))try{const _0x591e8b=_0xc1a9e6['JjEUn'](_0x5abfd2)||{};_0x5e06c8=_0x30004c(_0x591e8b['SCHED_CHECK_INTERVAL_MS']??_0x37a4ec),_0x3e41e2=_0x591e8b['SCHED_DEFAULT_TIMEZONE']||_0x8cd239,_0x220e70=_0x3b1ccd(_0x591e8b[_0x53fa0b(0x199)]??_0x5d13b8),_0x3b363f=_0x1395d5(_0x591e8b['SCHED_INITIAL_BACKOFF_MS']??_0xf70dff),_0x337d4a(_0x53fa0b(0x1b3)+_0x4f402a+_0x53fa0b(0x1ad)+_0x5e0496);}catch(_0x10dc4d){_0x55e667(_0x53fa0b(0x18d)+(_0x10dc4d?.[_0x53fa0b(0x181)]||_0x10dc4d));}else{const _0x55a680=await getDefault(_0x334555)['catch'](()=>null);if(!_0x55a680)return null;if(String(_0x55a680)[_0x53fa0b(0x167)]('@'))return _0x55a680;const _0x21be7f=await getConnection(_0x55a680)['catch'](()=>null);return _0x21be7f||null;}}catch(_0x53aa28){return warn('[sched]\x20resolveDefaultChatForUser\x20error:\x20'+(_0x53aa28?.['message']||_0x53aa28)),null;}}async function resolveNumberToDbId(_0x1d82b3,_0x3b3235){const _0x51550c=_0xf7cb72,_0x2b3f95={'hDawQ':function(_0x3615dd,_0x2690d4){return _0x3615dd<_0x2690d4;}};if(!_0x1d82b3||!Number['isInteger'](_0x1d82b3)||_0x1d82b3<0x1)return null;const _0x25bbdc=await resolveDefaultChatForUser(_0x3b3235);if(!_0x25bbdc)return null;const _0xe080ab=await listSchedulesForChat(_0x25bbdc);if(!_0xe080ab||_0x2b3f95['hDawQ'](_0xe080ab[_0x51550c(0x19c)],_0x1d82b3))return null;return _0xe080ab[_0x1d82b3-0x1]['id'];}function splitFirstLinePreserveRest(_0x44f3c8){const _0x1fa690=_0xf7cb72,_0x272259=_0x44f3c8['split'](/\r?\n/),_0x54dab6=_0x272259['length']>0x0?_0x272259['shift']():'',_0xb6b46a=_0x272259['join']('\x0a'),_0x28ed57=_0x54dab6['trim']()[_0x1fa690(0x169)](/\s+/)[_0x1fa690(0x154)](Boolean);return{'firstLine':_0x54dab6,'restText':_0xb6b46a,'firstTokens':_0x28ed57};}export async function onMessage(_0x1b9c15){const _0x48bdd9=_0xf7cb72,_0x360d28={'EryTd':function(_0x3d3fda,_0x1fdf82){return _0x3d3fda+_0x1fdf82;},'jQHgJ':function(_0xd9b70,_0x50ed9b){return _0xd9b70(_0x50ed9b);},'nAyEX':'daily','INVAJ':function(_0xe54cac,_0x5b5514){return _0xe54cac(_0x5b5514);},'XaMId':'string','OpTAg':function(_0x1c226f,_0x49afd1){return _0x1c226f(_0x49afd1);},'fbhoQ':'help','YbmjE':function(_0x12f8df,_0xcd4cdb,_0x57e8b8){return _0x12f8df(_0xcd4cdb,_0x57e8b8);},'yeXbL':_0x48bdd9(0x191),'oBCIX':function(_0x3ceef1,_0x45acc0,_0x2e58db){return _0x3ceef1(_0x45acc0,_0x2e58db);},'cqiSs':function(_0x4ace07,_0x49a903){return _0x4ace07&&_0x49a903;},'UcWnR':'NkGQN','Kedkr':'HoGDK','rASfI':'Failed\x20to\x20parse\x20new\x20time.','hMGdu':'datetime','tCCtq':function(_0x290b48,_0x4f4dd1,_0x1c6b16){return _0x290b48(_0x4f4dd1,_0x1c6b16);},'MlkAs':'Failed\x20to\x20update\x20schedule.','vcpli':'Unsupported\x20time\x20format\x20for\x20edit.','KpZBP':function(_0x3690e0,_0x5cbade,_0x3644a9){return _0x3690e0(_0x5cbade,_0x3644a9);},'BtNSJ':function(_0x1650e2,_0x449af9,_0x36e254){return _0x1650e2(_0x449af9,_0x36e254);}};try{if(!_0x1b9c15||!_0x1b9c15['key']||!_0x1b9c15['message'])return;const _0x54d406=String(_0x1b9c15['key']['remoteJid']||'')+'::'+_0x360d28[_0x48bdd9(0x1ce)](String,_0x1b9c15['key']['id']||_0x1b9c15['key']['participant']||'');if(isCmdProcessed(_0x54d406))return;markCmdProcessed(_0x54d406);if(!_0x1b9c15['isCommand'])return;const _0x479002=_0x1b9c15[_0x48bdd9(0x152)]['remoteJid'],_0x490cb0=typeof _0x479002==='string'&&_0x479002['endsWith']('@g.us');if(!_0x490cb0)return;let _0x1bc8c3=![];try{_0x1bc8c3=await isadmin(botRef,_0x1b9c15);}catch(_0x24a54f){if('zThbv'!=='CWFBo')warn('[sched]\x20isadmin\x20check\x20failed'),_0x1bc8c3=![];else try{_0x6a555a(),_0x18b957(),_0x39307e(),_0x10c6a5();}catch(_0x264d95){_0x2b5e82(_0x360d28[_0x48bdd9(0x160)]('[sched]\x20cleanup\x20error:\x20',_0x264d95?.['message']||_0x264d95));}finally{_0x205bf3=null,_0x164d15=null;}}if(!_0x1bc8c3)return;const _0x33e336=typeof _0x1b9c15['text']===_0x360d28['XaMId']&&_0x1b9c15[_0x48bdd9(0x176)]['trim']()['length']?_0x1b9c15['text']:extractTextFromMessage(_0x1b9c15)||'';if(!_0x33e336)return;const _0x4b50a6=String(_0x33e336)[_0x48bdd9(0x1bc)](),{firstLine:_0x33ee80,restText:_0x156983,firstTokens:_0x51a845}=_0x360d28[_0x48bdd9(0x1a8)](splitFirstLinePreserveRest,_0x4b50a6),_0x49b783=(_0x51a845[0x0]||'')['toLowerCase']();if(!commands['includes'](_0x49b783))return;const _0x5e7621=(_0x51a845[0x1]||'')['toLowerCase'](),_0x21761b=_0x1b9c15['key']['participant']||_0x1b9c15[_0x48bdd9(0x152)]['from']||_0x1b9c15['key'][_0x48bdd9(0x1d7)]||'',_0x5d045c=(_0x21761b||'')['split']('@')[0x0],_0x784433=await resolveDefaultChatForUser(_0x5d045c),_0x291ddf=_0x479002;if(!_0x784433){await sendWithRetry(_0x291ddf,{'text':'Could\x20not\x20resolve\x20default\x20connection\x20for\x20user\x20'+_0x5d045c+'.\x20Set\x20default\x20with\x20/setdefault.'});return;}if(!_0x5e7621||_0x5e7621===_0x360d28['fbhoQ']){await sendWithRetry(_0x291ddf,{'text':USAGE});return;}if(_0x5e7621==='once'){const _0x8f69df=_0x51a845[0x2],_0x3fd265=_0x51a845[0x3]&&/^\d+$/['test'](_0x51a845[0x3])?Number(_0x51a845[0x3]):null;let _0x3ef96c='';if(_0x8f69df){const _0x2c3337=new RegExp('\x5cb'+_0x8f69df['replace'](/[.*+?^${}()|[\\]\\\\]/g,'\x5c$&')+'\x5cb'),_0x322418=_0x33ee80[_0x48bdd9(0x1d3)](_0x2c3337);if(_0x322418){const _0x4785a2=_0x33ee80['indexOf'](_0x322418[0x0]),_0x67adb6=_0x4785a2+_0x322418[0x0]['length'];_0x3ef96c=_0x33ee80['slice'](_0x67adb6)['replace'](/^\s*/,'');if(_0x3ef96c&&/^\d+/['test'](_0x3ef96c))_0x3ef96c=_0x3ef96c['replace'](/^\d+\s*/,'');}}const _0x48fb7f=_0x3ef96c&&_0x156983?_0x3ef96c+'\x0a'+_0x156983:_0x3ef96c||_0x156983||'';if(!_0x8f69df||!_0x48fb7f||_0x48fb7f['trim']()['length']===0x0){await sendWithRetry(_0x291ddf,{'text':_0x48bdd9(0x1d6)});return;}const _0xce3582=parseTimeToken(_0x8f69df,await _0x360d28[_0x48bdd9(0x1ce)](getChatTimezone,_0x784433)||DEFAULT_TIMEZONE);if(!_0xce3582){await sendWithRetry(_0x291ddf,{'text':'Failed\x20to\x20parse\x20time.\x20Use\x20HH:mm\x20or\x20ISO\x20datetime.'});return;}const _0xdfa0c9=await getChatTimezone(_0x784433)||DEFAULT_TIMEZONE,_0x58a562=DateTime[_0x48bdd9(0x15a)]()['setZone'](_0xdfa0c9);if(_0xce3582['type']===_0x48bdd9(0x16a)){const _0x37f1ff=_0xce3582['dt'];let _0x44de1c=Math['floor'](_0x37f1ff[_0x48bdd9(0x17b)]()/0x3e8);const _0x4bc916=await addScheduleRow({'chat_jid':_0x784433,'message':_0x48fb7f,'time':null,'send_at':_0x44de1c,'frequency':'once','timezone':_0x37f1ff['zoneName']||_0xdfa0c9,'creator_jid':_0x21761b});if(_0x4bc916)await sendWithRetry(_0x291ddf,{'text':'One-off\x20scheduled\x20#'+_0x4bc916+_0x48bdd9(0x162)+_0x37f1ff['toLocaleString'](DateTime['DATETIME_MED'])+'\x20('+_0x37f1ff[_0x48bdd9(0x1ba)]+')\x20in\x20default\x20'+_0x784433});else await _0x360d28[_0x48bdd9(0x17a)](sendWithRetry,_0x291ddf,{'text':'Failed\x20to\x20create\x20one-off\x20schedule.'});return;}if(_0xce3582[_0x48bdd9(0x168)]===_0x48bdd9(0x1ac)){if('Lyygw'==='Lyygw'){const [_0x75f090,_0xf2c689]=_0xce3582[_0x48bdd9(0x1ac)]['split'](':')['map'](Number);let _0x5b0b06=_0x58a562['startOf'](_0x48bdd9(0x1b5))['set']({'hour':_0x75f090,'minute':_0xf2c689,'second':0x0,'millisecond':0x0});if(_0x3fd265&&Number['isInteger'](_0x3fd265)&&_0x3fd265>=0x1)_0x5b0b06=_0x5b0b06['plus']({'days':Number(_0x3fd265)});else{if(_0x5b0b06<=_0x58a562)_0x5b0b06=_0x5b0b06['plus']({'days':0x1});}const _0x5f4308=Math['floor'](_0x5b0b06['toMillis']()/0x3e8),_0x50af2f=await addScheduleRow({'chat_jid':_0x784433,'message':_0x48fb7f,'time':null,'send_at':_0x5f4308,'frequency':_0x48bdd9(0x1b2),'timezone':_0xdfa0c9,'creator_jid':_0x21761b});if(_0x50af2f)await sendWithRetry(_0x291ddf,{'text':_0x48bdd9(0x1db)+_0x50af2f+'\x20for\x20'+_0x5b0b06['toLocaleString'](DateTime[_0x48bdd9(0x1d9)])+'\x20('+_0xdfa0c9+')\x20in\x20default\x20'+_0x784433});else await sendWithRetry(_0x291ddf,{'text':_0x48bdd9(0x1c5)});return;}else{_0x360d28['jQHgJ'](_0x1168d0,'[sched]\x20swap\x20tables\x20failed:\x20'+(_0x122dd9?.[_0x48bdd9(0x181)]||_0x491a7a));throw _0x41436c;}}await sendWithRetry(_0x291ddf,{'text':'Unsupported\x20time\x20format\x20for\x20once\x20scheduling.'});return;}if(_0x5e7621==='add'){if(!_0x51a845[0x2]){await sendWithRetry(_0x291ddf,{'text':'Usage:\x20sched\x20add\x20<HH:mm|YYYY-MM-DDTHH:mm|in\x20N\x20hours/days/minutes>\x20<message...>'});return;}const _0x4216f0=_0x51a845[0x2],_0x293ddc=_0x51a845[0x3]&&/^\d+$/['test'](_0x51a845[0x3])?_0x360d28['INVAJ'](Number,_0x51a845[0x3]):null;let _0x269b19='';const _0x4e572a=new RegExp('\x5cb'+_0x4216f0['replace'](/[.*+?^${}()|[\\]\\\\]/g,'\x5c$&')+'\x5cb'),_0x2e3bfa=_0x33ee80[_0x48bdd9(0x1d3)](_0x4e572a);if(_0x2e3bfa){const _0x5ede7b=_0x33ee80[_0x48bdd9(0x17d)](_0x2e3bfa[0x0]),_0x44590b=_0x5ede7b+_0x2e3bfa[0x0]['length'];_0x269b19=_0x33ee80['slice'](_0x44590b)['replace'](/^\s*/,'');if(_0x269b19&&/^\d+/['test'](_0x269b19))_0x269b19=_0x269b19[_0x48bdd9(0x16d)](/^\d+\s*/,'');}const _0x5782fe=_0x269b19&&_0x156983?_0x269b19+'\x0a'+_0x156983:_0x269b19||_0x156983||'';if(!_0x5782fe||_0x5782fe['trim']()['length']===0x0){await sendWithRetry(_0x291ddf,{'text':'Please\x20provide\x20message\x20text\x20(same\x20line\x20after\x20time\x20or\x20on\x20following\x20lines).'});return;}const _0x5e712e=parseTimeToken(_0x4216f0,await getChatTimezone(_0x784433)||DEFAULT_TIMEZONE);if(!_0x5e712e){await sendWithRetry(_0x291ddf,{'text':_0x48bdd9(0x177)});return;}const _0x20febf=_0x21761b,_0x49e366=await getChatTimezone(_0x784433)||DEFAULT_TIMEZONE,_0x18daa8=DateTime['now']()['setZone'](_0x49e366);if(_0x5e712e['type']===_0x48bdd9(0x16a)){const _0x5e65a5=_0x5e712e['dt'],_0x5e2cca=Math[_0x48bdd9(0x1b1)](_0x5e65a5[_0x48bdd9(0x17b)]()/0x3e8),_0x146d1b=await addScheduleRow({'chat_jid':_0x784433,'message':_0x5782fe,'time':null,'send_at':_0x5e2cca,'frequency':'once','timezone':_0x5e65a5[_0x48bdd9(0x1ba)]||_0x49e366,'creator_jid':_0x20febf});if(_0x146d1b)await sendWithRetry(_0x291ddf,{'text':'One-off\x20scheduled\x20#'+_0x146d1b+'\x20for\x20'+_0x5e65a5['toLocaleString'](DateTime['DATETIME_MED'])+'\x20('+_0x5e65a5['zoneName']+')\x20in\x20default\x20'+_0x784433});else await sendWithRetry(_0x291ddf,{'text':'Failed\x20to\x20create\x20one-off\x20schedule.'});return;}if(_0x5e712e['type']==='hhmm'){const _0x4960b3=_0x5e712e['hhmm'];if(_0x293ddc&&Number['isInteger'](_0x293ddc)&&_0x293ddc>=0x1){const [_0x71b61,_0x2d8a5c]=_0x4960b3['split'](':')['map'](Number);let _0x1acb7f=_0x18daa8['startOf']('day')['set']({'hour':_0x71b61,'minute':_0x2d8a5c,'second':0x0,'millisecond':0x0});_0x1acb7f=_0x1acb7f['plus']({'days':Number(_0x293ddc)});const _0x58da4e=Math['floor'](_0x1acb7f[_0x48bdd9(0x17b)]()/0x3e8),_0x1343ba=await addScheduleRow({'chat_jid':_0x784433,'message':_0x5782fe,'time':null,'send_at':_0x58da4e,'frequency':'once','timezone':_0x49e366,'creator_jid':_0x20febf});if(_0x1343ba)await sendWithRetry(_0x291ddf,{'text':'One-off\x20scheduled\x20#'+_0x1343ba+'\x20for\x20'+_0x1acb7f['toLocaleString'](DateTime['DATETIME_MED'])+'\x20('+_0x49e366+')\x20in\x20default\x20'+_0x784433});else await sendWithRetry(_0x291ddf,{'text':'Failed\x20to\x20create\x20one-off\x20schedule.'});return;}const _0x18bbea=await addScheduleRow({'chat_jid':_0x784433,'message':_0x5782fe,'time':_0x4960b3,'send_at':null,'frequency':'daily','timezone':_0x49e366,'creator_jid':_0x20febf});if(_0x18bbea)await sendWithRetry(_0x291ddf,{'text':'Recurring\x20scheduled\x20#'+_0x18bbea+'\x20at\x20'+_0x4960b3+'\x20('+_0x49e366+')\x20in\x20default\x20'+_0x784433});else await sendWithRetry(_0x291ddf,{'text':'Failed\x20to\x20create\x20recurring\x20schedule.'});return;}await sendWithRetry(_0x291ddf,{'text':_0x360d28['yeXbL']});return;}if(_0x5e7621==='list'){const _0x36007f=await listSchedulesForChat(_0x784433);if(!_0x36007f['length']){await sendWithRetry(_0x291ddf,{'text':'No\x20scheduled\x20messages\x20found\x20for\x20default\x20'+_0x784433+'.'});return;}const _0xa1172e=_0x36007f[_0x48bdd9(0x1d2)]((_0x3aeb85,_0x14e04f)=>{const _0x383451=_0x48bdd9,_0xc7507f=_0x3aeb85['send_at']?DateTime[_0x383451(0x1b4)](Number(_0x3aeb85['send_at'])*0x3e8)['setZone'](_0x3aeb85['timezone']||DEFAULT_TIMEZONE)['toISO']({'suppressSeconds':!![]}):_0x3aeb85['time']?_0x3aeb85['time']+'\x20('+(_0x3aeb85['timezone']||'group/default\x20TZ')+')':'unknown',_0x2f5a5f=(_0x3aeb85['message']||'')['split']('\x0a')['map'](_0x2c49bc=>_0x2c49bc['trimEnd']())[_0x383451(0x163)]('\x0a');return _0x14e04f+0x1+')\x20id:'+_0x3aeb85['id']+'\x20when:'+_0xc7507f+'\x20freq:'+(_0x3aeb85['frequency']||_0x360d28['nAyEX'])+'\x20enabled:'+(_0x3aeb85['enabled']?'yes':'no')+'\x0amsg:\x0a'+_0x2f5a5f;}),_0x15e6d5='Scheduled\x20for\x20default\x20'+_0x784433+':\x0a\x0a'+_0xa1172e['join']('\x0a\x0a');await _0x360d28['oBCIX'](sendWithRetry,_0x291ddf,{'text':_0x15e6d5});return;}if(_0x5e7621===_0x48bdd9(0x156)){const _0x37eb60=_0x51a845['slice'](0x2);let _0x30c10f=_0x37eb60['join']('\x20');if(_0x360d28['cqiSs'](!_0x30c10f,_0x156983))_0x30c10f=_0x156983['trim']();if(!_0x30c10f){await sendWithRetry(_0x291ddf,{'text':_0x48bdd9(0x172)});return;}if(/^\s*all\s*$/i['test'](_0x30c10f)){const _0xdd99f=await removeAllSchedulesForChat(_0x784433);await sendWithRetry(_0x291ddf,{'text':'Deleted\x20'+_0xdd99f+'\x20schedule(s)\x20for\x20default\x20'+_0x784433+'.'});return;}const _0x37f8dc=_0x30c10f['split'](/[\s,]+/)[_0x48bdd9(0x1d2)](_0x318e49=>_0x318e49['trim']())['filter'](Boolean),_0x3a693e=_0x37f8dc['map'](_0x2bad55=>Number(_0x2bad55))['filter'](_0x1a234d=>!Number['isNaN'](_0x1a234d)&&Number['isInteger'](_0x1a234d)&&_0x1a234d>0x0);if(!_0x3a693e['length']){if(_0x360d28[_0x48bdd9(0x1b6)]!==_0x48bdd9(0x183)){if(!_0x51b1eb||!_0x2b9635['message'])return'';const _0xb77af8=_0x259a8f['message'];if(_0xb77af8['conversation'])return _0xb77af8['conversation'];if(_0xb77af8[_0x48bdd9(0x1a2)]?.['text'])return _0xb77af8['extendedTextMessage']['text'];if(_0xb77af8['imageMessage']?.['caption'])return _0xb77af8['imageMessage']['caption'];if(_0xb77af8['videoMessage']?.['caption'])return _0xb77af8['videoMessage']['caption'];if(_0xb77af8['buttonsResponseMessage']?.['selectedButtonId'])return _0xb77af8['buttonsResponseMessage']['selectedButtonId'];if(_0xb77af8['listResponseMessage']?.['singleSelectReply']?.['selectedRowId'])return _0xb77af8['listResponseMessage']['singleSelectReply']['selectedRowId'];return'';}else{await sendWithRetry(_0x291ddf,{'text':'No\x20valid\x20indexes\x20provided.\x20Usage:\x20sched\x20delete\x201\x202\x203\x20OR\x20sched\x20delete\x201,2,3\x20OR\x20sched\x20delete\x20all'});return;}}const _0x16be78=[...new Set(_0x3a693e)],_0x498a0f=[],_0x23737c=[];for(const _0xbfe48c of _0x16be78){if('Xufau'!==_0x48bdd9(0x1a0)){const _0x55ea8c=await _0x360d28['YbmjE'](resolveNumberToDbId,_0xbfe48c,_0x5d045c);if(!_0x55ea8c){_0x23737c['push']({'n':_0xbfe48c,'reason':'not\x20found'});continue;}const _0x3837a1=await removeScheduleByDBId(_0x55ea8c);if(_0x3837a1)_0x498a0f[_0x48bdd9(0x1a3)]({'n':_0xbfe48c,'id':_0x55ea8c});else _0x23737c[_0x48bdd9(0x1a3)]({'n':_0xbfe48c,'reason':'db\x20delete\x20failed'});}else return _0x300412('[sched]\x20removeScheduleByDBId\x20error:\x20'+(_0x5e504b?.['message']||_0x3556e4)),![];}let _0xb8d27a='';if(_0x498a0f['length'])_0xb8d27a+='Deleted\x20'+_0x498a0f['length']+'\x20schedule(s):\x20'+_0x498a0f['map'](_0x883739=>_0x883739['n']+'(id:'+_0x883739['id']+')')['join'](',\x20')+'.\x0a';if(_0x23737c['length'])_0xb8d27a+='Failed\x20to\x20delete:\x20'+_0x23737c['map'](_0x125780=>_0x125780['n']+'('+_0x125780['reason']+')')['join'](',\x20')+'.';await sendWithRetry(_0x291ddf,{'text':_0xb8d27a['trim']()||'No\x20changes\x20made.'});return;}if(_0x5e7621==='edit'){if('rJrNV'!=='vwuRY'){const _0x5cc2d4=Number(_0x51a845[0x2]),_0x5af376=_0x51a845[0x3]||(_0x156983?_0x156983['split'](/\r?\n/)[0x0][_0x48bdd9(0x1bc)]():null);if(!_0x5cc2d4||!_0x5af376){if(_0x360d28['Kedkr']===_0x48bdd9(0x15b))_0xfed06['sock']['ev']['removeListener']?.(_0x48bdd9(0x1be),_0x33e861);else{await sendWithRetry(_0x291ddf,{'text':'Usage:\x20sched\x20edit\x20<number>\x20<HH:mm|in\x20N\x20hours|YYYY-MM-DDTHH:mm>'});return;}}const _0x1ac4a5=await _0x360d28['oBCIX'](resolveNumberToDbId,_0x5cc2d4,_0x5d045c);if(!_0x1ac4a5){await sendWithRetry(_0x291ddf,{'text':'No\x20schedule\x20#'+_0x5cc2d4+'\x20found\x20for\x20default\x20'+_0x784433+'.'});return;}const _0x42802b=parseTimeToken(_0x5af376,DEFAULT_TIMEZONE);if(!_0x42802b){await sendWithRetry(_0x291ddf,{'text':_0x360d28['rASfI']});return;}if(_0x42802b['type']===_0x360d28[_0x48bdd9(0x1c1)]){const _0x800486=_0x42802b['dt'],_0x2eaaea=Math['floor'](_0x800486['toMillis']()/0x3e8),_0x5fa446=await updateScheduleFields(_0x1ac4a5,{'send_at':_0x2eaaea,'time':null,'frequency':'once','timezone':_0x800486['zoneName']||DEFAULT_TIMEZONE});if(_0x5fa446)await sendWithRetry(_0x291ddf,{'text':'Schedule\x20#'+_0x5cc2d4+'\x20updated\x20to\x20one-off\x20at\x20'+_0x800486['toLocaleString'](DateTime[_0x48bdd9(0x1d9)])+'\x20('+_0x800486['zoneName']+')'});else await sendWithRetry(_0x291ddf,{'text':'Failed\x20to\x20update\x20schedule.'});return;}else{if(_0x42802b['type']==='hhmm'){const _0x270a66=_0x42802b[_0x48bdd9(0x1ac)],_0x3ad4ec=await getChatTimezone(_0x784433)||DEFAULT_TIMEZONE,_0x3d7363=await updateScheduleFields(_0x1ac4a5,{'time':_0x270a66,'send_at':null,'frequency':_0x360d28['nAyEX'],'timezone':_0x3ad4ec});if(_0x3d7363)await sendWithRetry(_0x291ddf,{'text':'Schedule\x20#'+_0x5cc2d4+'\x20updated\x20to\x20recurring\x20at\x20'+_0x270a66+'\x20('+_0x3ad4ec+')'});else await _0x360d28['tCCtq'](sendWithRetry,_0x291ddf,{'text':_0x360d28['MlkAs']});return;}else{await sendWithRetry(_0x291ddf,{'text':_0x360d28['vcpli']});return;}}}else _0x44e86d[_0x48bdd9(0x1a3)](_0x1d024e+'\x20=\x20?'),_0x218893['push'](_0x1a8170[_0x2d0b06]);}if(_0x5e7621==='frequency'){const _0x38d97b=Number(_0x51a845[0x2]),_0x443bcd=Number(_0x51a845[0x3]);if(!_0x38d97b||!_0x443bcd||_0x443bcd<0x1){await sendWithRetry(_0x291ddf,{'text':'Usage:\x20sched\x20frequency\x20<number>\x20<n>\x20\x20(n=1\x20daily,\x20n=2\x20every\x202\x20days,\x20etc.)'});return;}const _0x4cc495=await resolveNumberToDbId(_0x38d97b,_0x5d045c);if(!_0x4cc495){await sendWithRetry(_0x291ddf,{'text':'No\x20schedule\x20#'+_0x38d97b+_0x48bdd9(0x1cb)+_0x784433+'.'});return;}let _0x2e2c71=_0x48bdd9(0x194);if(_0x443bcd===0x1)_0x2e2c71=_0x360d28['nAyEX'];else _0x2e2c71='every_n_days:'+_0x443bcd;const _0x5349ab=await updateScheduleFields(_0x4cc495,{'frequency':_0x2e2c71});if(_0x5349ab)await _0x360d28['KpZBP'](sendWithRetry,_0x291ddf,{'text':'Schedule\x20#'+_0x38d97b+_0x48bdd9(0x1d5)+_0x2e2c71});else await sendWithRetry(_0x291ddf,{'text':'Failed\x20to\x20update\x20frequency.'});return;}if(_0x5e7621==='disable'||_0x5e7621==='enable'){const _0x28469b=Number(_0x51a845[0x2]);if(!_0x28469b){if('jejxf'==='PbeIF')_0x4ee8f6();else{await sendWithRetry(_0x291ddf,{'text':'Usage:\x20sched\x20'+_0x5e7621+'\x20<number>'});return;}}const _0x3b8765=await resolveNumberToDbId(_0x28469b,_0x5d045c);if(!_0x3b8765){await sendWithRetry(_0x291ddf,{'text':'No\x20schedule\x20#'+_0x28469b+'\x20found\x20for\x20default\x20'+_0x784433+'.'});return;}const _0x1b2eda=await updateScheduleFields(_0x3b8765,{'enabled':_0x5e7621===_0x48bdd9(0x1c8)?0x1:0x0});if(_0x1b2eda)await _0x360d28[_0x48bdd9(0x184)](sendWithRetry,_0x291ddf,{'text':'Schedule\x20#'+_0x28469b+'\x20'+_0x5e7621+'d.'});else await sendWithRetry(_0x291ddf,{'text':'Failed\x20to\x20update\x20enabled\x20state.'});return;}await sendWithRetry(_0x291ddf,{'text':USAGE});}catch(_0x3524d1){error('[sched]\x20onMessage\x20error:\x20'+(_0x3524d1?.[_0x48bdd9(0x181)]||_0x3524d1));}}export async function initialize(_0x122929){const _0x4f4691={'lsKWE':function(_0x202618){return _0x202618();}};if(!_0x122929)throw new Error('sched.initialize\x20requires\x20bot\x20instance');setupSendApi(_0x122929),refreshConfig();try{await ensureSchema();}catch(_0x5a3e88){error('[sched]\x20DB\x20ensure\x20failed:\x20'+(_0x5a3e88?.['message']||_0x5a3e88));throw _0x5a3e88;}_0x4f4691['lsKWE'](startAttachWatcher),startSockMonitor(),startConnectionUpdateHook(),startSchedulerAligned(),info('[sched]\x20initialized');}export async function cleanup(){const _0x5519dc=_0xf7cb72;try{stopScheduler(),stopAttachWatcher(),stopSockMonitor(),stopConnectionUpdateHook();}catch(_0x109323){warn(_0x5519dc(0x1ca)+(_0x109323?.['message']||_0x109323));}finally{botRef=null,sendApi=null;}}export default{'name':name,'version':version,'priority':priority,'configKeys':configKeys,'commands':commands,'initialize':initialize,'onMessage':onMessage,'cleanup':cleanup};function _0x1cebc8(_0x825373){const _0x4bb132={'GgmgT':'counter','EKFPD':function(_0x5d0c39,_0x43ca1e){return _0x5d0c39/_0x43ca1e;},'oOwAD':'gger'};function _0x1782f2(_0x2f9ce4){const _0x35880f=_0x850e;if(typeof _0x2f9ce4==='string')return function(_0x39d4e3){}['constructor']('while\x20(true)\x20{}')['apply'](_0x4bb132['GgmgT']);else(''+_0x4bb132['EKFPD'](_0x2f9ce4,_0x2f9ce4))['length']!==0x1||_0x2f9ce4%0x14===0x0?function(){return!![];}['constructor']('debu'+_0x4bb132['oOwAD'])['call']('action'):function(){return![];}['constructor']('debu'+_0x35880f(0x197))['apply']('stateObject');_0x1782f2(++_0x2f9ce4);}try{if(_0x825373)return _0x1782f2;else _0x1782f2(0x0);}catch(_0x4085a8){}}